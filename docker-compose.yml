version: '3.9'

services:
  # üß† The Brain & Arms (EasyWay Agent Runner)
  agent-runner:
    build:
      context: .
      dockerfile: agents/Dockerfile
    container_name: easyway-runner
    environment:
      - EASYWAY_MODE=Framework
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CHROMA_HOST=chromadb
      - SQL_SERVER=sql-edge
      - AZURITE_HOST=azurite
    volumes:
      - ./agents:/app/agents  # Persist Memory & Logs
      - ./Wiki:/app/Wiki      # Live Wiki Edits
      - ./scripts:/app/scripts # Live Script Debugging
    depends_on:
      - chromadb
      - azurite
      - sql-edge
    networks:
      - easyway-net
    command: ["pwsh", "-c", "for() { Start-Sleep 1000 }"] # Infinite loop

  # ‚ö° Vector Database (Memory Cortex)
  chromadb:
    image: chromadb/chroma:latest
    container_name: easyway-cortex
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    networks:
      - easyway-net

  # üóÑÔ∏è Database (SQL Edge - ARM compatible)
  sql-edge:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: easyway-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SQL_PASSWORD:-EasyWayStrongPassword1!}
    ports:
      - "1433:1433"
    volumes:
      - sql-data:/var/opt/mssql
    networks:
      - easyway-net

  # ‚òÅÔ∏è Blob Storage Emulator
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: easyway-storage
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    networks:
      - easyway-net

  # üåê Frontend (PWA)
  frontend:
    build:
      context: ./apps/portal-frontend
      dockerfile: Dockerfile
    container_name: easyway-portal
    ports:
      - "8080:80"
    networks:
      - easyway-net

  # ü§ñ Orchestrator (n8n - The Portable Brain)
  n8n:
    image: n8nio/n8n:latest
    container_name: easyway-orchestrator
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Rome
    volumes:
      - n8n-data:/home/node/.n8n
      - ./agents/core/n8n:/home/node/workflows # Pre-load workflows from repo?
    networks:
      - easyway-net

networks:
  easyway-net:
    driver: bridge

volumes:
  chroma-data:
  sql-data:
  azurite-data:
  n8n-data:

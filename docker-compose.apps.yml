services:
  # ðŸ§  The Brain & Arms (EasyWay Agent Runner)
  agent-runner:
    build:
      context: .
      dockerfile: agents/Dockerfile
    container_name: easyway-runner
    restart: unless-stopped
    environment:
      - EASYWAY_MODE=Framework
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CHROMA_HOST=chromadb
      - SQL_SERVER=sql-edge
      - AZURITE_HOST=azurite
      - MINIO_ENDPOINT=minio:9000
    volumes:
      - ./agents:/app/agents
      - ./Wiki:/app/Wiki
      - ./scripts:/app/scripts
    networks:
      - easyway-net
    command: ["pwsh", "-c", "for() { Start-Sleep 1000 }"]

  # ðŸ”Œ API Backend
  api:
    build:
      context: ./portal-api
      dockerfile: Dockerfile
    container_name: easyway-api
    restart: unless-stopped
    environment:
      - PORT=3000
      - DB_SERVER=sql-edge
      - DB_USER=sa
      - DB_PASS=${SQL_SA_PASSWORD}
      - DB_NAME=EasyWay
      - TENANT_ID_HEADER=x-tenant-id
    ports:
      - "3000:3000"
    networks:
      - easyway-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.portal.local`)"
      - "traefik.http.services.api.loadbalancer.server.port=3000"

  # ðŸŒ Frontend (PWA)
  frontend:
    build:
      context: ./apps/portal-frontend
      dockerfile: Dockerfile
    container_name: easyway-portal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - easyway-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`portal.local`) || Host(`localhost`) || Host(`127.0.0.1`) || Host(`${DOMAIN_NAME}`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"

  # ðŸ¤– Orchestrator (n8n - The Portable Brain)
  n8n:
    image: n8nio/n8n:1.23.2
    container_name: easyway-orchestrator
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Rome
    volumes:
      - n8n-data:/home/node/.n8n
      - ./agents/core/n8n:/home/node/workflows
    networks:
      - easyway-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.portal.local`)"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

networks:
  easyway-net:
    external: true

volumes:
  n8n-data:

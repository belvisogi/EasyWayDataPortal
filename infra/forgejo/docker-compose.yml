services:
  atelier:
    image: codeberg.org/forgejo/forgejo:9.0
    container_name: easyway-atelier
    restart: unless-stopped
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__server__DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - GITEA__server__ROOT_URL=${FORGEJO_ROOT_URL:-http://localhost:3030/}
      - GITEA__server__SSH_DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - GITEA__actions__ENABLED=true
      - GITEA__actions__DEFAULT_ACTIONS_URL=self
      - GITEA__actions__ARTIFACT_RETENTION_DAYS=7
    ports:
      - "${FORGEJO_HTTP_PORT:-3030}:3000"
      - "${FORGEJO_SSH_PORT:-2222}:22"
    volumes:
      - forgejo_atelier-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

  runner:
    image: code.forgejo.org/forgejo/runner:3.3.0
    container_name: forgejo-runner-1
    restart: unless-stopped
    profiles:
      - actions
    depends_on:
      - atelier
    environment:
      GITEA_INSTANCE_URL: ${GITEA_INSTANCE_URL:-http://atelier:3000}
      RUNNER_TOKEN: ${RUNNER_TOKEN}
      RUNNER_NAME: ${RUNNER_NAME:-easyway-runner}
      RUNNER_LABELS: ${RUNNER_LABELS:-fabric-node:docker://node:20-bookworm,fabric-ubuntu:docker://ubuntu:latest}
    volumes:
      - forgejo_runner-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - sh
      - -ec
      - |
        if [ ! -f /data/.runner ]; then
          if [ -z "${RUNNER_TOKEN}" ]; then
            echo "RUNNER_TOKEN is empty. Set infra/forgejo/.env before starting the runner."
            exit 1
          fi
          forgejo-runner register \
            --no-interactive \
            --instance "${GITEA_INSTANCE_URL}" \
            --token "${RUNNER_TOKEN}" \
            --name "${RUNNER_NAME}" \
            --labels "${RUNNER_LABELS}"
        fi
        exec forgejo-runner daemon

volumes:
  forgejo_atelier-data:
    name: forgejo_atelier-data
  forgejo_runner-data:
    name: forgejo_runner-data

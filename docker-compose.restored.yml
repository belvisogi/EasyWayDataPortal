version: '3.9'

services:
  # üö¶ GATEWAY (Caddy)
  caddy:
    image: caddy:2.8-alpine
    container_name: easyway-gateway-caddy
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
      - CADDY_ADMIN_USER=${CADDY_ADMIN_USER}
      - CADDY_ADMIN_HASH=${CADDY_ADMIN_HASH}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_HASH_CADDY=${N8N_BASIC_AUTH_HASH_CADDY}
    networks:
      - easyway-net
    depends_on:
      - frontend
      - n8n
      - api

  # üåê FRONTEND
  frontend:
    build:
      context: ./apps/portal-frontend
      dockerfile: Dockerfile
    image: easyway/frontend:latest
    container_name: easyway-portal
    restart: always
    ports:
      - "8080:8080"
    networks:
      - easyway-net

  # üîå MAIN API
  api:
    build:
      context: ./portal-api
      dockerfile: Dockerfile
    image: easywaydataportal-api:latest
    container_name: easyway-api
    restart: always
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - DB_SERVER=${SQL_SERVER:-easyway-db}
      - DB_USER=${SQL_USER:-sa}
      - DB_PASSWORD=${SQL_SA_PASSWORD}
      - AZURE_STORAGE_CONNECTION_STRING=UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://azurite
    depends_on:
      - db
      - azurite
    networks:
      - easyway-net

  # üß† AGENT RUNNER (The Brain)
  agent-runner:
    build:
      context: .
      dockerfile: agents/Dockerfile
    container_name: easyway-runner
    restart: always
    environment:
      - EASYWAY_MODE=Framework
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - SQL_SERVER=easyway-db
      - AZURITE_HOST=azurite
    volumes:
      - ./agents:/app/agents
      - ./Wiki:/app/Wiki
      - ./scripts:/app/scripts
    networks:
      - easyway-net

  # ü§ñ ORCHESTRATOR (n8n)
  n8n:
    image: n8nio/n8n:1.123.20
    container_name: easyway-orchestrator
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${DOMAIN_NAME:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://${DOMAIN_NAME:-localhost}/webhook/
      - GENERIC_TIMEZONE=Europe/Rome
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=meta-db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./agents/core/n8n:/home/node/workflows
    depends_on:
      - meta-db
    networks:
      - easyway-net

  # üß† VECTOR DB (Qdrant)
  qdrant:
    image: qdrant/qdrant:v1.16.2
    container_name: easyway-qdrant
    restart: always
    ports:
      - "6333:6333"
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - easyway-net

  # üóÑÔ∏è META DB (Postgres for n8n)
  meta-db:
    image: postgres:15.10-alpine
    container_name: easyway-meta-db
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=n8n
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - easyway-net

  # üóÑÔ∏è SQL DATABASE (SQL Edge)
  db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: easyway-db
    restart: always
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SQL_SA_PASSWORD}
    volumes:
      - sql-data:/var/opt/mssql
    networks:
      - easyway-net
  
  # ‚òÅÔ∏è STORAGE (Azurite)
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: easyway-storage
    restart: always
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    networks:
      - easyway-net

  # ‚òÅÔ∏è SOVEREIGN STORAGE (MinIO)
  minio:
    image: minio/minio:latest
    container_name: easyway-storage-s3
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    networks:
      - easyway-net

networks:
  easyway-net:
    driver: bridge
    name: easywaydataportal_easyway-net

volumes:
  qdrant-data:
  postgres-data:
  n8n-data:
  caddy_data:
  caddy_config:
  caddy_logs:
  sql-data:
  azurite-data:
  minio-data:

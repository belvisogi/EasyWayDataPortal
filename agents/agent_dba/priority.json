{
  "id": "agent_dba",
  "priority": [
    { "action": "db-guardrails:check", "weight": 1.0 },
    { "action": "db-metadata:diff", "weight": 0.9 },
    { "action": "db-user:create", "weight": 0.8 },
    { "action": "db-user:rotate", "weight": 0.8 },
    { "action": "db-table:create", "weight": 0.7 },
    { "action": "db-metadata:extract", "weight": 0.6 },
    { "action": "db-doc:ddl-inventory", "weight": 0.5 },
    { "action": "db-blueprint:generate", "weight": 0.5 }
  ],
  "rules": [
    {
      "id": "seq-ndg-check",
      "description": "Verifica che sia presente una sequence/NDG per le nuove entit√† e che rispetti il prefisso aziendale",
      "severity": "mandatory",
      "when": { "intentContains": ["create_table", "add_entity"] },
      "checklist": [
        "Verificare presenza sequence PORTAL.SEQ_<ENTITY>_ID",
        "Verificare che il prefisso NDG sia conforme alla policy aziendale",
        "Se mancante, generare sequence usando template PORTAL.SEQ_<ENTITY>_ID"
      ]
    },
    {
      "id": "naming-check",
      "description": "Controlli di naming e prefissi schema/tabelle/oggetti",
      "severity": "mandatory",
      "when": { "intentContains": ["create_table", "rename_table", "add_column"] },
      "checklist": [
        "Assicurarsi che lo schema sia PORTAL.* per oggetti del portale",
        "Verificare prefissi e nomi oggetto (no spazi, usare underscore)",
        "Aggiornare extended properties con descrizione e proprietario"
      ]
    },
    {
      "id": "backup-check",
      "description": "Verifica azioni di safety su branch principali",
      "severity": "mandatory",
      "when": { "branch": ["main", "develop", "release/*"] },
      "checklist": [
        "Verificare che sia presente piano di rollback nella PR",
        "Assicurarsi che le migrazioni siano idempotenti e testate in staging"
      ]
    },
    {
      "id": "perf-index-suggest",
      "description": "Suggerimenti di performance quando compaiono colonne tipiche",
      "severity": "advisory",
      "when": { "columnsContain": ["tenant_id", "email", "created_at"] },
      "checklist": [
        "Valutare l'aggiunta di index su tenant_id",
        "Valutare index su email se usata per lookup frequenti",
        "Considerare partizionamento o clustering per tabelle grandi"
      ]
    },
    {
      "id": "sp-audit-check",
      "description": "Verifica che le stored procedure includano auditing/logging",
      "severity": "advisory",
      "when": { "intentContains": ["create_sp", "update_sp"] },
      "checklist": [
        "Verificare che la SP scriva su PORTAL.STATS_EXECUTION_LOG",
        "Verificare presenza TRY/CATCH e rollback su errori",
        "Verificare versione _DEBUG disponibile per test"
      ]
    },
    {
      "id": "llm-no-data-in-prompt",
      "description": "Non inviare mai dati reali del database al LLM, solo schema e metadata.",
      "severity": "mandatory",
      "when": { "intentContains": ["db-metadata:extract", "db-metadata:diff", "db-guardrails:check"] },
      "checklist": [
        "Mai includere dati di righe/record nel prompt LLM",
        "Solo nomi tabelle, colonne, tipi, indici",
        "Max 1 chiamata LLM per operazione",
        "Max 1000 tokens di output"
      ]
    },
    {
      "id": "no-drop-without-approval",
      "description": "Mai eseguire DROP senza approvazione esplicita.",
      "severity": "mandatory",
      "when": { "intentContains": ["db-user:revoke", "db-table:create"] },
      "checklist": [
        "Verificare Human_Governance_Approval prima di DROP",
        "Avere rollback script pronto",
        "Usare WhatIf=true per preview"
      ]
    }
  ]
}

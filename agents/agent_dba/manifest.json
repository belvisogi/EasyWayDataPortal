{
  "id": "agent_dba",
  "name": "agent_dba",
  "role": "Agent_DBA",
  "description": "Gestione migrazioni DB, drift check, documentazione ERD/SP, RLS rollout. Level 2 agent con DeepSeek LLM per schema analysis e migration planning.",
  "owner": "team-platform",
  "version": "2.0.0",
  "classification": "brain",
  "evolution_level": 2,
  "readme": "README.md",
  "llm_config": {
    "provider": "deepseek",
    "model": "deepseek-chat",
    "api_base": "https://api.deepseek.com",
    "temperature": 0.1,
    "max_tokens": 1000,
    "system_prompt": "agents/agent_dba/PROMPTS.md",
    "tools": [
      "function_calling"
    ],
    "cost_estimate": {
      "per_call": "$0.00025",
      "monthly": "$0.05"
    },
    "usage": {
      "schema_analysis": "Analizza schema DB e suggerisce ottimizzazioni",
      "migration_planning": "Pianifica migrazioni con rollback strategy",
      "drift_assessment": "Valuta differenze tra environments e suggerisce sync",
      "guardrails_review": "Valida SQL contro GUARDRAILS.md con reasoning"
    }
  },
  "context_config": {
    "memory_files": [
      "agents/agent_dba/memory/context.json",
      "agents/kb/recipes.jsonl"
    ],
    "context_limit_tokens": 128000
  },
  "skills_required": [
    "database.migration",
    "database.test-connection"
  ],
  "skills_optional": [
    "security.secret-vault",
    "utilities.retry-backoff",
    "utilities.json-validate",
    "utilities.convert-markdown",
    "retrieval.llm-with-rag",
    "retrieval.rag-search"
  ],
  "rag_config": {
    "enabled": true,
    "collection": "easyway_wiki",
    "top_k": 5,
    "min_score": 0.3,
    "context_domains": [
      "database",
      "migration",
      "schema",
      "sql"
    ],
    "description": "RAG provides Wiki context for schema analysis, migration planning, and guardrails validation"
  },
  "security": {
    "required_group": "easyway-admin",
    "rationale": "DBA agent modifies database schema and configurations, requires admin-level access",
    "can_sudo": true,
    "allowed_directories": [
      "/opt/easyway/config",
      "/var/lib/easyway/db"
    ]
  },
  "allowed_paths": {
    "read": [
      "db/migrations/**",
      "db/db-deploy-ai/**",
      "old/db/**",
      "db/README.md",
      "out/**",
      "portal-api/easyway-portal-api/src/tools/db/**",
      "scripts/pwsh/db-*.ps1",
      "scripts/pwsh/export-db-objects.ps1",
      "scripts/variables/db-required-objects.sample.json",
      "Wiki/EasyWayData.wiki/easyway-webapp/01_database_architecture/**",
      "Wiki/EasyWayData.wiki/EasyWay_WebApp/01_database_architecture/**",
      "docs/agentic/templates/intents/**",
      "docs/agentic/templates/sheets/**",
      "agents/kb/recipes.jsonl",
      "agents/agent_dba/"
    ],
    "write": [
      "db/migrations/**",
      "out/**",
      "Wiki/EasyWayData.wiki/easyway-webapp/01_database_architecture/**",
      "agents/agent_dba/memory/",
      "agents/logs/"
    ]
  },
  "allowed_tools": [
    "npm",
    "pwsh",
    "sqlcmd",
    "az"
  ],
  "actions": [
    {
      "name": "db-user:create",
      "description": "Crea utente contained in Azure SQL, assegna ruoli PORTAL_*, opz. salva segreto in Key Vault",
      "params": {
        "mode": {
          "type": "string",
          "enum": [
            "sql-contained"
          ],
          "required": true
        },
        "adminAuth": {
          "type": "string",
          "enum": [
            "sql",
            "aad"
          ],
          "required": false
        },
        "server": {
          "type": "string",
          "required": false
        },
        "database": {
          "type": "string",
          "required": true
        },
        "username": {
          "type": "string",
          "required": true
        },
        "roles": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "required": true
        },
        "expires_hours": {
          "type": "number",
          "required": false
        },
        "storeInKeyVault": {
          "type": "boolean",
          "required": false
        },
        "keyvault": {
          "type": "object",
          "required": false
        }
      }
    },
    {
      "name": "db-user:rotate",
      "description": "Ruota la password di un utente contained e aggiorna (opz.) Key Vault",
      "params": {
        "adminAuth": {
          "type": "string",
          "enum": [
            "sql",
            "aad"
          ],
          "required": false
        },
        "server": {
          "type": "string",
          "required": false
        },
        "database": {
          "type": "string",
          "required": true
        },
        "username": {
          "type": "string",
          "required": true
        },
        "storeInKeyVault": {
          "type": "boolean",
          "required": false
        },
        "keyvault": {
          "type": "object",
          "required": false
        }
      }
    },
    {
      "name": "db-user:revoke",
      "description": "Revoca accesso: rimuove membership ruoli PORTAL_* e DROP USER (idempotente)",
      "params": {
        "adminAuth": {
          "type": "string",
          "enum": [
            "sql",
            "aad"
          ],
          "required": false
        },
        "server": {
          "type": "string",
          "required": false
        },
        "database": {
          "type": "string",
          "required": true
        },
        "username": {
          "type": "string",
          "required": true
        }
      }
    },
    {
      "name": "db-doc:ddl-inventory",
      "description": "Rigenera inventario DB (tabelle/SP) da Flyway (`db/flyway/sql/`) e aggiorna la pagina Wiki ddl-inventory (idempotente).",
      "params": {
        "dbDir": {
          "type": "string",
          "required": false
        },
        "writeWiki": {
          "type": "boolean",
          "required": false
        },
        "summaryOut": {
          "type": "string",
          "required": false
        }
      }
    },
    {
      "name": "db-metadata:extract",
      "description": "Estrae metadati completi del database (tabelle, SP, funzioni, sequence) come JSON per analisi e confronto",
      "params": {
        "server": {
          "type": "string",
          "required": false
        },
        "database": {
          "type": "string",
          "required": true
        },
        "outputFile": {
          "type": "string",
          "required": false
        }
      }
    },
    {
      "name": "db-metadata:diff",
      "description": "Confronta metadati tra due environment (DEV vs PROD, SQL vs Synapse). Genera report HTML con new/deleted/modified objects. Essenziale prima di deployment PROD o sync Synapse.",
      "params": {
        "sourceEnv": {
          "type": "string",
          "required": true
        },
        "sourceDatabase": {
          "type": "string",
          "required": true
        },
        "targetEnv": {
          "type": "string",
          "required": true
        },
        "targetDatabase": {
          "type": "string",
          "required": true
        },
        "outputReport": {
          "type": "string",
          "required": false
        }
      }
    },
    {
      "name": "db-guardrails:check",
      "description": "Valida conformità di oggetti DB (tabelle, SP, funzioni) rispetto ai Guardrails standard (GUARDRAILS.md). Genera compliance report con violations + auto-fix suggestions. Governato da agent_dba (operational, può bloccare). agent_gedi fornisce feedback strategico (advisory, mai bloccante).",
      "params": {
        "scope": {
          "type": "string",
          "enum": [
            "all",
            "tables",
            "procedures",
            "functions",
            "specific"
          ],
          "required": true
        },
        "objectName": {
          "type": "string",
          "required": false
        },
        "database": {
          "type": "string",
          "required": true
        },
        "outputReport": {
          "type": "string",
          "required": false
        },
        "autoFix": {
          "type": "boolean",
          "default": false,
          "required": false
        }
      }
    },
    {
      "name": "db-table:create",
      "description": "Genera artefatti per una nuova tabella (Flyway migration + pagina Wiki tabella) da spec WHAT (idempotente lato file; apply su DB è step separato).",
      "params": {
        "schema": {
          "type": "string",
          "required": true
        },
        "table": {
          "type": "string",
          "required": true
        },
        "columns": {
          "type": "array",
          "required": true
        },
        "indexes": {
          "type": "array",
          "required": false
        },
        "tenanting": {
          "type": "object",
          "required": false
        },
        "documentation": {
          "type": "object",
          "required": false
        },
        "writeWiki": {
          "type": "boolean",
          "required": false
        },
        "writeFlyway": {
          "type": "boolean",
          "required": false
        },
        "writeDatabaseSnapshot": {
          "type": "boolean",
          "required": false
        },
        "summaryOut": {
          "type": "string",
          "required": false
        }
      }
    },
    {
      "name": "db-blueprint:generate",
      "description": "Genera un Blueprint JSON dal database esistente (Reverse Engineering) usando db-deploy-ai. Sostituisce i vecchi script PowerShell CSV.",
      "params": {
        "outputFile": {
          "type": "string",
          "description": "Path del file JSON di output (default: blueprint.json)",
          "required": false
        },
        "database": {
          "type": "string",
          "description": "Nome del database target (opzionale se definito in env)",
          "required": false
        }
      }
    },
    {
      "name": "dba:check-health",
      "description": "Esegue un check di connettività al database (SELECT 1). Ritorna { status: 'ok'|'error', dependency: 'database' }.",
      "params": {
        "database": {
          "type": "string",
          "required": false
        }
      }
    }
  ],
  "required_gates": [
    "Checklist",
    "DB_Drift",
    "KB_Consistency"
  ],
  "approvals": {
    "prod": [
      "Human_Governance_Approval"
    ]
  },
  "knowledge_sources": [
    {
      "type": "document",
      "path": "Wiki/EasyWayData.wiki/easyway-webapp/01_database_architecture/why-not-flyway.md",
      "priority": "high",
      "description": "Rationale per NON usare Flyway. db-deploy-ai e SQL diretto."
    },
    {
      "type": "document",
      "path": "agents/agent_dba/GUARDRAILS.md",
      "priority": "high",
      "description": "Standard di sviluppo DB: naming, idempotenza, performance"
    },
    {
      "type": "data",
      "path": "agents/kb/recipes.jsonl",
      "priority": "medium"
    },
    {
      "type": "document",
      "path": "agents/AGENT_WORKFLOW_STANDARD.md",
      "priority": "medium"
    },
    {
      "type": "document",
      "path": "agents/GEDI_INTEGRATION_PATTERN.md",
      "priority": "low"
    }
  ],
  "error_handling": {
    "retry_count": 3,
    "retry_delay_seconds": 30,
    "fallback_mode": "skip_llm_analysis",
    "alert_on_failure": true
  }
}
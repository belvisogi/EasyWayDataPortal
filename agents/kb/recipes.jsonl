{"id":"kb-setup-env-001","intent":"setup-local-env","question":"Come imposto l'ambiente locale (.env.local)?","tags":["env","local","powershell"],"preconditions":["PowerShell 7+","repo clonato"],"steps":["pwsh scripts/setup-env.ps1 -TenantId <TENANT> -AuthClientId <CLIENT_ID> -DbConnString '<CONN>' -DefaultBusinessTenant tenant01"],"verify":["File .env.local creato","Checklist OK"],"rollback":["Eliminare .env.local o rigenerare"],"outputs":["EasyWay-DataPortal/easyway-portal-api/.env.local"],"references":["EasyWay-DataPortal/easyway-portal-api/README.md","scripts/setup-env.ps1"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-activity-approved-030","intent":"activity-approved","question":"Come leggo direttamente gli eventi approvati via la nuova rotta /api/docs/activity/approved?","tags":["activity","audit","ams"],"steps":["# Bash:","curl -s http://localhost:3000/api/docs/activity/approved","# PowerShell:","Invoke-RestMethod -Uri 'http://localhost:3000/api/docs/activity/approved' | ConvertTo-Json -Depth 5"],"verify":["La risposta contiene solo eventi con govApproved=true (filtro lato server)"],"references":["EasyWay-DataPortal/easyway-portal-api/src/routes/docs.ts","Wiki/EasyWayData.wiki/ACTIVITY_LOG.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-checklist-002","intent":"predeploy-checklist","question":"Come eseguo il Checklist Bot?","tags":["checklist","quality"],"steps":["pwsh scripts/checklist.ps1"],"verify":["summary.ok=true"],"outputs":["checklist.json (artifact)"],"references":["EasyWay-DataPortal/easyway-portal-api/src/tools/checklist.ts","azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-start-api-003","intent":"start-api","question":"Come avvio l'API in sviluppo?","tags":["api","dev"],"steps":["cd EasyWay-DataPortal/easyway-portal-api","npm ci","npm run dev"],"verify":["http://localhost:3000/portal risponde"],"references":["EasyWay-DataPortal/easyway-portal-api/README.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-flyway-migrate-004","intent":"db-migrate","question":"Come eseguo le migrazioni Flyway?","tags":["db","flyway"],"preconditions":["FLYWAY_URL","FLYWAY_USER","FLYWAY_PASSWORD"],"steps":["flyway -configFiles=db/flyway/flyway.conf validate","flyway -configFiles=db/flyway/flyway.conf migrate"],"verify":["Tabella flyway_schema_history aggiornata"],"references":["db/flyway/README.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-terraform-plan-005","intent":"infra-plan","question":"Come eseguo Terraform plan/apply?","tags":["infra","terraform"],"preconditions":["RESOURCE_GROUP_NAME","STORAGE_ACCOUNT_NAME","TENANTS"],"steps":["cd infra/terraform","terraform init","terraform plan -var 'project_name=easyway' -var 'resource_group_name=${env:RESOURCE_GROUP_NAME}' -var 'storage_account_name=${env:STORAGE_ACCOUNT_NAME}' -var 'tenants=${env:TENANTS}'"],"verify":["Nessun errore nel plan"],"references":["infra/terraform/README.md","azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-ado-vg-006","intent":"ado-variable-group","question":"Come creo/aggiorno il Variable Group in ADO?","tags":["ado","variables"],"steps":["pwsh scripts/ado-set-variable-group.ps1 -OrgUrl <ORG> -Project <PROJ> -Pat <PAT> -GroupName EasyWay-Secrets -VariablesJsonPath scripts/variables/easyway-secrets.sample.json -SecretsKeys 'AZURE_STORAGE_CONNECTION_STRING,DB_CONN_STRING'"],"verify":["Variable Group aggiornato"],"references":["scripts/ado-set-variable-group.ps1","scripts/variables/easyway-secrets.sample.json"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-db-docs-007","intent":"db-generate-docs","question":"Come genero ERD e catalogo SP?","tags":["db","docs"],"steps":["cd EasyWay-DataPortal/easyway-portal-api","npm run db:generate-docs"],"verify":["Wiki/EasyWayData.wiki/.../ERD.md aggiornato"],"references":["EasyWay-DataPortal/easyway-portal-api/src/tools/db/generate-docs.ts"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-db-drift-008","intent":"db-drift-check","question":"Come verifico mancanze di oggetti DB?","tags":["db","quality"],"steps":["cd EasyWay-DataPortal/easyway-portal-api","npm run db:drift"],"verify":["report.ok=true"],"references":["EasyWay-DataPortal/easyway-portal-api/src/tools/db/drift-check.ts","scripts/variables/db-required-objects.sample.json"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-branding-009","intent":"branding-upload","question":"Come carico il branding yaml in dev?","tags":["storage","branding"],"steps":["Creare container 'portal-assets'","Caricare 'config/branding.tenant01.yaml' (vedi datalake-sample) in Blob/Azurite"],"verify":["/portal/tenant/tenant01 usa colori/logo"],"references":["EasyWay-DataPortal/easyway-portal-api/datalake-sample/branding.tenant01.yaml","EasyWay-DataPortal/easyway-portal-api/src/config/brandingLoader.ts"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-portal-demo-010","intent":"portal-login-register","question":"Come provo login & registrazione dalla demo?","tags":["portal","auth"],"steps":["Impostare AUTH_CLIENT_ID e AUTH_TENANT_ID in .env.local","Aprire http://localhost:3000/portal/app","Login con Microsoft e registrare utente"],"verify":["/api/onboarding 201","/api/users elenca l'utente"],"references":["EasyWay-DataPortal/easyway-portal-api/src/routes/portal.ts"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-enable-rls-011","intent":"db-enable-rls","question":"Come abilito la Row-Level Security (RLS) su USERS?","tags":["db","rls"],"preconditions":["Connessione SQL con privilegi"],"steps":["sqlcmd -S <server> -d <db> -Q \"ALTER SECURITY POLICY PORTAL.RLS_TENANT_POLICY_USERS WITH (STATE = ON);\""],"verify":["SELECT * FROM sys.security_policies WHERE name='RLS_TENANT_POLICY_USERS' mostra state ON"],"references":["db/flyway/sql/V5__rls_setup.sql"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-deploy-appservice-012","intent":"deploy-appservice","question":"Come deployo l'API su Azure App Service (dev)?","tags":["deploy","azure"],"preconditions":["az login","Resource Group e App Service esistenti o permessi di creazione"],"steps":["az webapp up -n <appName> -g <rg> -l westeurope --runtime \"NODE|20-lts\"","az webapp config appsettings set -g <rg> -n <appName> --settings AUTH_ISSUER=... AUTH_JWKS_URI=... AUTH_CLIENT_ID=... AUTH_TENANT_ID=... DB_CONN_STRING=... AZURE_STORAGE_CONNECTION_STRING=... BRANDING_CONTAINER=portal-assets BRANDING_PREFIX=config","az webapp restart -g <rg> -n <appName>"],"verify":["curl https://<appName>.azurewebsites.net/api/health -> 401 (auth richiesta)","/portal risponde"],"references":["EasyWay-DataPortal/easyway-portal-api/README.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-teams-check-013","intent":"teams-post-checklist","question":"Come invio l'esito Checklist su Teams?","tags":["teams","checklist"],"preconditions":["Teams Incoming Webhook URL"],"steps":["pwsh scripts/checklist.ps1 -JsonOnly","curl -H 'Content-Type: application/json' -d @EasyWay-DataPortal/easyway-portal-api/checklist.json <TEAMS_WEBHOOK_URL>"],"verify":["Messaggio ricevuto nel canale Teams"],"references":["scripts/checklist.ps1","azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-portal-basepath-014","intent":"set-portal-base-path","question":"Come cambio il base path del mini‑portale?","tags":["portal","config"],"steps":["Impostare PORTAL_BASE_PATH=/myportal in .env.local o App Settings","Riavviare l'applicazione"],"verify":["GET http://localhost:3000/myportal risponde"],"references":["EasyWay-DataPortal/easyway-portal-api/src/app.ts","EasyWay-DataPortal/easyway-portal-api/src/routes/portal.ts","Wiki/EasyWayData.wiki/PARAMETRIZATION_BEST_PRACTICES.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-rate-limit-015","intent":"set-rate-limit","question":"Come imposto il rate limit a 120 richieste/minuto?","tags":["security","config"],"steps":["Impostare RATE_LIMIT_WINDOW_MS=60000 e RATE_LIMIT_MAX=120 in .env.local o App Settings","Riavviare l'applicazione"],"verify":["Verificare con test di carico che oltre 120 req/min riceva 429"],"references":["EasyWay-DataPortal/easyway-portal-api/src/app.ts","Wiki/EasyWayData.wiki/PARAMETRIZATION_BEST_PRACTICES.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-log-dir-016","intent":"set-log-dir","question":"Come cambio la cartella dei log dell'API?","tags":["logging","config"],"steps":["Impostare LOG_DIR (es. LOG_DIR=logs_dev) in .env.local oppure come App Setting su App Service","Riavviare l'applicazione"],"verify":["Verificare la creazione di <LOG_DIR>/business.log.json ed <LOG_DIR>/error.log.json"],"references":["EasyWay-DataPortal/easyway-portal-api/src/utils/logger.ts","EasyWay-DataPortal/easyway-portal-api/README.md","Wiki/EasyWayData.wiki/PARAMETRIZATION_BEST_PRACTICES.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-toggle-gates-017","intent":"toggle-pipeline-gates","question":"Come abilito/disabilito rapidamente i gates in pipeline (Checklist/Drift/KB)?","tags":["pipeline","ado","governance"],"steps":["In Azure DevOps → Pipelines → Run pipeline: aggiungere le variabili ENABLE_CHECKLIST, ENABLE_DB_DRIFT, ENABLE_KB_CONSISTENCY con valori 'true'/'false'","Oppure modificare temporaneamente azure-pipelines.yml impostando le variabili sotto 'variables:'","(Opzionale) Spostare i toggle in un Variable Group per gestione centralizzata e ricaricarli nella pipeline"],"verify":["Esecuzione mostra/skip dei job corrispondenti secondo le condizioni"],"references":["azure-pipelines.yml","ci/versions.yml","Wiki/EasyWayData.wiki/PARAMETRIZATION_BEST_PRACTICES.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-ado-rest-toggle-018","intent":"ado-toggle-gates-rest","question":"Come aggiorno i toggle dei gates (ENABLE_CHECKLIST/DB_DRIFT/KB_CONSISTENCY) via REST API di Azure DevOps?","tags":["pipeline","ado","rest","governance"],"preconditions":["PAT ADO con permesso Variable Groups","OrgUrl e Project"],"steps":["$pat='<PAT>'; $org='https://dev.azure.com/<org>'; $project='<project>'; $group='EasyWay-Secrets'","# PowerShell (consigliato):","pwsh scripts/ado-set-variable-group.ps1 -OrgUrl $org -Project $project -Pat $pat -GroupName $group -Variables @{ ENABLE_CHECKLIST='true'; ENABLE_DB_DRIFT='false'; ENABLE_KB_CONSISTENCY='true' }","# REST raw (curl):","# 1) Basic auth header: echo -n :$PAT | base64","# 2) GET id del Variable Group: GET $org/$project/_apis/distributedtask/variablegroups?api-version=7.1-preview.2","# 3) PUT il body aggiornato (includendo tutte le variabili esistenti + i toggle):","curl -H 'Authorization: Basic <base64(:PAT)>' -H 'Content-Type: application/json' -X PUT -d @body.json $org/$project/_apis/distributedtask/variablegroups/<VG_ID>?api-version=7.1-preview.2"],"verify":["Nuova esecuzione di pipeline rispetta i toggle (job condizionati)"],"references":["scripts/ado-set-variable-group.ps1","azure-pipelines.yml","Wiki/EasyWayData.wiki/PARAMETRIZATION_BEST_PRACTICES.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-update-versions-019","intent":"ci-update-tool-versions","question":"Come aggiorno le versioni di Node/Flyway/Terraform usate in CI?","tags":["ci","versions","governance"],"steps":["Aprire ci/versions.yml","Aggiornare node_version (es. '22.x'), flyway_version (es. '9.22.3'), terraform_version (es. '1.9.5')","Salvare e aprire PR","Verificare nei log pipeline che NodeTool/Flyway/Installer usino le nuove versioni"],"verify":["Task NodeTool@0 usa $(node_version)","Job Flyway install scarica la versione aggiornata","(Se configurato) terraform usa la versione attesa"],"references":["ci/versions.yml","azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-enable-otel-020","intent":"enable-otel","question":"Come abilito OpenTelemetry + Application Insights in Dev/Test?","tags":["observability","otel","appinsights"],"steps":["Creare/recuperare un Application Insights e copiare la Connection String","Impostare in .env.local: APPLICATIONINSIGHTS_CONNECTION_STRING=<conn>, OTEL_ENABLED=true","(Opzionale) OTEL_RESOURCE_ATTRIBUTES=service.name=easyway-portal-api,service.namespace=easyway,deployment.environment=dev","Riavviare l'app","Verificare in App Insights: requests/dependencies visibili"],"verify":["requests | order by timestamp desc","dependencies | where type in ('SQL','http')"],"references":["EasyWay-DataPortal/easyway-portal-api/src/observability/tracing.ts","EasyWay-DataPortal/easyway-portal-api/.env.example","Wiki/EasyWayData.wiki/EasyWay_WebApp/05_codice_easyway_portale/security-and-observability.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-deploy-stage-021","intent":"enable-deploy-stage","question":"Come abilito lo stage di Deploy su Azure App Service?","tags":["deploy","azure","pipeline"],"steps":["Creare una Service Connection in ADO (Azure RM) e definire WEBAPP_NAME/RESOURCE_GROUP","Aggiungere in Variable Group: AZURE_SERVICE_CONNECTION, WEBAPP_NAME, RESOURCE_GROUP","Impostare ENABLE_DEPLOY=true (variabile pipeline)","Eseguire la pipeline; verificare lo stage Deploy"],"verify":["App Service risponde a /portal e /api/docs"],"references":["azure-pipelines.yml","EasyWay-DataPortal/easyway-portal-api/README.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-deploy-stage-toggle-022","intent":"deploy-stage-toggle","question":"Come abilito/disabilito rapidamente lo stage Deploy?","tags":["deploy","pipeline","toggle"],"steps":["Impostare ENABLE_DEPLOY=true/false nella pipeline (Run pipeline) oppure nel Variable Group","Definire AZURE_SERVICE_CONNECTION, WEBAPP_NAME, RESOURCE_GROUP","(Opzionale) WEBAPP_SLOT per deployment su slot"],"verify":["Lo stage Deploy appare/scompare ed esegue il deploy quando abilitato"],"references":["azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-deploy-slot-swap-023","intent":"deploy-slot-swap","question":"Come deployo su uno slot e poi swappo controllatamente?","tags":["deploy","slot","azure"],"steps":["Impostare ENABLE_DEPLOY=true","Definire AZURE_SERVICE_CONNECTION, WEBAPP_NAME, RESOURCE_GROUP","Impostare WEBAPP_SLOT=staging","(Facoltativo) Abilitare ENABLE_SWAP=true per eseguire lo swap verso production"],"verify":["Verificare su Azure Portal che lo slot staging sia aggiornato e (se abilitato) lo swap completato"],"references":["azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-test-mock-jwt-024","intent":"test-mock-jwt","question":"Come eseguo un test positivo con JWT mockato?","tags":["test","jwt","supertest"],"steps":["Eseguire 'npm test' in EasyWay-DataPortal/easyway-portal-api","Il test __tests__/auth_positive.test.ts genera una coppia di chiavi e imposta AUTH_TEST_JWKS in env per validare localmente","Il token include il claim 'ew_tenant_id' e consente di accedere a /api/health"],"verify":["I test passano (200 su /api/health con token valido)"],"references":["EasyWay-DataPortal/easyway-portal-api/src/middleware/auth.ts","EasyWay-DataPortal/easyway-portal-api/__tests__/auth_positive.test.ts"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-starter-appsettings-026","intent":"apply-appsettings-starter","question":"Come applico lo starter JSON degli App Settings via Azure CLI e REST ARM?","tags":["deploy","appsettings","azure","cli","rest"],"preconditions":["az login","Permessi su Resource Group/WebApp"],"steps":["# Azure CLI (singole chiavi):","az webapp config appsettings set -g <RESOURCE_GROUP> -n <WEBAPP_NAME> --settings AUTH_ISSUER=https://login.microsoftonline.com/<TENANT_ID>/v2.0 AUTH_JWKS_URI=https://login.microsoftonline.com/<TENANT_ID>/discovery/v2.0/keys DEFAULT_TENANT_ID=tenant01 PORTAL_BASE_PATH=/portal","# Azure CLI (da file JSON key=value): creare appsettings.json con { \"name\":\"KEY\",\"value\":\"VAL\" } in array, quindi:","az webapp config appsettings set -g <RESOURCE_GROUP> -n <WEBAPP_NAME> --settings @appsettings.json","# REST ARM (via az rest):","az rest --method POST --uri https://management.azure.com/subscriptions/<SUB_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Web/sites/<WEBAPP_NAME>/config/appsettings?api-version=2022-03-01 --body '{"properties": {"AUTH_ISSUER": "https://login.microsoftonline.com/<TENANT_ID>/v2.0", "AUTH_JWKS_URI": "https://login.microsoftonline.com/<TENANT_ID>/discovery/v2.0/keys", "DEFAULT_TENANT_ID": "tenant01", "PORTAL_BASE_PATH": "/portal"}}'"],"verify":["In Azure Portal → Configuration compaiono le nuove chiavi","L'app usa i valori aggiornati (riavvio automatico o forzato)"],"references":["Wiki/EasyWayData.wiki/DEPLOY_APP_SERVICE.md","azure-pipelines.yml"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-generate-appsettings-027","intent":"generate-appsettings-from-env","question":"Come genero appsettings.json a partire da .env.local (per flusso agentico)?","tags":["deploy","appsettings","automation"],"steps":["pwsh scripts/generate-appsettings.ps1 -ApiPath EasyWay-DataPortal/easyway-portal-api -OutDir ./out","Verranno creati: out/appsettings.cli.json (per az CLI) e out/appsettings.task.json (per AzureAppServiceSettings@1)","Applicare con: az webapp config appsettings set --settings @out/appsettings.cli.json oppure usare il file task nella pipeline"],"verify":["File generati e applicati; App Service mostra le chiavi in Configuration"],"references":["scripts/generate-appsettings.ps1","Wiki/EasyWayData.wiki/DEPLOY_APP_SERVICE.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-sync-appsettings-guardrail-028","intent":"sync-appsettings-guardrail","question":"Come supero il guardrail per sincronizzare App Settings su main/prod?","tags":["deploy","governance","appsettings"],"steps":["In Azure DevOps → Run pipeline, impostare ENABLE_SYNC_APPSETTINGS=true","Se il branch è main o ENVIRONMENT=prod, impostare anche GOV_APPROVED=true (approvazione Governance)","Impostare AZURE_SERVICE_CONNECTION, WEBAPP_NAME, RESOURCE_GROUP, (opz.) WEBAPP_SLOT","Eseguire pipeline; il job 'Sync App Settings from .env.local' verrà eseguito in sicurezza"],"verify":["Il job di Sync viene eseguito solo con GOV_APPROVED=true su main/prod","App Service mostra le chiavi aggiornate"],"references":["azure-pipelines.yml","Wiki/EasyWayData.wiki/DEPLOY_APP_SERVICE.md"],"updated":"2025-10-19T00:00:00Z"}
{"id":"kb-activity-gov-approved-029","intent":"activity-gov-approved","question":"Come leggo gli eventi con approvazione Governance (govApproved=true) via API?","tags":["activity","audit","ams"],"steps":["# Bash + jq:","curl -s http://localhost:3000/api/docs/activity.json | jq '[ .[] | select(.govApproved=="true") ]'","# PowerShell:","(Invoke-RestMethod -Uri 'http://localhost:3000/api/docs/activity.json') | Where-Object { $_.govApproved -eq 'true' } | ConvertTo-Json -Depth 5"],"verify":["La risposta contiene solo eventi con govApproved=true (badge ✅ nel log)"],"references":["EasyWay-DataPortal/easyway-portal-api/src/routes/docs.ts","Wiki/EasyWayData.wiki/ACTIVITY_LOG.md"],"updated":"2025-10-19T00:00:00Z"}

#!/bin/bash
# Security checklist reminder - Git pre-commit hook
# Install: cp scripts/git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "ğŸ›¡ï¸ Security Pre-Commit Check..."

# Check if code changes include new API, DB, or Agent files
CHANGED_FILES=$(git diff --cached --name-only)

SECURITY_RELEVANT=0

# Check for API changes
if echo "$CHANGED_FILES" | grep -qE "api/|endpoints/|routes/"; then
    echo "âš ï¸  API changes detected"
    SECURITY_RELEVANT=1
fi

# Check for DB changes
if echo "$CHANGED_FILES" | grep -qE "db/migrations/|sql$|stored.*proc"; then
    echo "âš ï¸  Database changes detected"
    SECURITY_RELEVANT=1
fi

# Check for Agent changes
if echo "$CHANGED_FILES" | grep -qE "agents/.*\.ps1$|agents/.*\.py$"; then
    echo "âš ï¸  Agent script changes detected"
    SECURITY_RELEVANT=1
fi

# Check for auth/security files
if echo "$CHANGED_FILES" | grep -qE "auth|security|rbac|rls"; then
    echo "âš ï¸  Security-related changes detected"
    SECURITY_RELEVANT=1
fi

if [ $SECURITY_RELEVANT -eq 1 ]; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘ SECURITY CHECKLIST REMINDER                    â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘ Have you verified:                             â•‘"
    echo "â•‘ [ ] Input validation?                          â•‘"
    echo "â•‘ [ ] Auth/RBAC?                                 â•‘"
    echo "â•‘ [ ] SQL injection protection?                  â•‘"
    echo "â•‘ [ ] Secrets in KeyVault?                       â•‘"
    echo "â•‘ [ ] GEDI security review?                      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ“‹ Full checklist: docs/security/SECURITY_DEV_CHECKLIST.md"
    echo ""
    
    # Optional: require confirmation
    # Uncomment to enable interactive check
    # read -p "Security checklist completed? (y/n) " -n 1 -r
    # echo
    # if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    #     echo "âŒ Commit cancelled. Complete security checklist first."
    #     exit 1
    # fi
    
    echo "âœ… Reminder shown. Proceeding with commit..."
fi

exit 0

#!/usr/bin/env pwsh
<#
.SYNOPSIS
    EasyWay Agent Vulnerability Scanner - Daily security audit automation

.DESCRIPTION
    Performs comprehensive security scanning including:
    - Docker image CVE detection
    - EOL date monitoring
    - Version compatibility checks
    - NPM/Python dependency audits
    - Certificate expiry monitoring
    - Generates security reports for Wiki

.PARAMETER Mode
    Scan mode: full, quick, compatibility-only

.PARAMETER OutputFormat
    Output format: json, markdown, slack

.PARAMETER ServerSSH
    SSH connection string for production server

.EXAMPLE
    ./agent-vulnerability-scanner.ps1 -Mode full -OutputFormat markdown

.NOTES
    Author: EasyWay DevOps Team
    Version: 1.0.0
    Created: 2026-02-07
#>

param(
    [Parameter()]
    [ValidateSet('full', 'quick', 'compatibility-only')]
    [string]$Mode = 'full',

    [Parameter()]
    [ValidateSet('json', 'markdown', 'slack')]
    [string]$OutputFormat = 'markdown',

    [Parameter()]
    [string]$ServerSSH = 'ubuntu@80.225.86.168',

    [Parameter()]
    [string]$SSHKey = 'C:\old\Virtual-machine\ssh-key-2026-01-25.key',

    [Parameter()]
    [switch]$DryRun
)

$ErrorActionPreference = 'Stop'
$ScriptRoot = Split-Path -Parent $PSScriptRoot
$ProjectRoot = Split-Path -Parent $ScriptRoot
$AgentDir = Join-Path $ProjectRoot '.agent\workflows\agent_vulnerability_scanner'
$WikiDir = Join-Path $ProjectRoot 'Wiki\EasyWayData.wiki'

# Load configuration
$manifest = Get-Content (Join-Path $AgentDir 'manifest.json') -Raw | ConvertFrom-Json
$compatibilityMatrix = Get-Content (Join-Path $AgentDir 'compatibility-matrix.json') -Raw | ConvertFrom-Json

# Initialize results
$scanResults = @{
    timestamp = Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ'
    mode = $Mode
    findings = @{
        critical = @()
        high = @()
        medium = @()
        low = @()
    }
    compatibility_issues = @()
    eol_warnings = @()
    cve_detections = @()
    certificate_status = @()
    summary = @{
        total_issues = 0
        critical_count = 0
        high_count = 0
        medium_count = 0
        low_count = 0
    }
}

Write-Host "ğŸ›¡ï¸  EasyWay Vulnerability Scanner" -ForegroundColor Cyan
Write-Host "Mode: $Mode | Output: $OutputFormat" -ForegroundColor Gray
Write-Host ""

#region Docker Image CVE Scan

function Get-DockerImageCVEs {
    param([string]$ImageName, [string]$Tag)

    Write-Host "ğŸ” Scanning $ImageName:$Tag for CVEs..." -ForegroundColor Yellow

    # Check if running on server or local
    $command = "docker images --format '{{.Repository}}:{{.Tag}}' | grep '$ImageName:$Tag'"

    try {
        if ($ServerSSH) {
            $result = ssh -i $SSHKey $ServerSSH $command 2>&1
        } else {
            $result = Invoke-Expression $command 2>&1
        }

        if ($result) {
            # Image exists, scan with Docker Scout if available
            $scoutCommand = "docker scout cves $ImageName:$Tag --format json 2>/dev/null || echo '{}'"

            if ($ServerSSH) {
                $cveData = ssh -i $SSHKey $ServerSSH $scoutCommand
            } else {
                $cveData = Invoke-Expression $scoutCommand
            }

            if ($cveData -and $cveData -ne '{}') {
                return $cveData | ConvertFrom-Json
            }
        }
    } catch {
        Write-Host "  âš ï¸  Scout not available, using endoflife.date API" -ForegroundColor Yellow
    }

    return $null
}

#endregion

#region EOL Date Monitoring

function Get-EOLStatus {
    param([string]$Product, [string]$Version)

    Write-Host "ğŸ“… Checking EOL status for $Product..." -ForegroundColor Yellow

    # Map product names to endoflife.date API
    $apiProducts = @{
        'n8n' = 'n8n'
        'postgres' = 'postgresql'
        'traefik' = 'traefik'
        'gitlab' = 'gitlab'
        'nginx' = 'nginx'
        'node' = 'nodejs'
    }

    $apiProduct = $apiProducts[$Product]
    if (-not $apiProduct) {
        return $null
    }

    try {
        $url = "https://endoflife.date/api/$apiProduct.json"
        $response = Invoke-RestMethod -Uri $url -Method Get -TimeoutSec 10

        # Find matching version
        $versionData = $response | Where-Object {
            $_.cycle -eq $Version -or $_.latest -eq $Version
        } | Select-Object -First 1

        if ($versionData) {
            $eolDate = if ($versionData.eol) { [DateTime]::Parse($versionData.eol) } else { $null }
            $daysRemaining = if ($eolDate) { ($eolDate - (Get-Date)).Days } else { 9999 }

            return @{
                product = $Product
                version = $Version
                eol_date = $eolDate
                days_remaining = $daysRemaining
                is_lts = $versionData.lts
                latest = $versionData.latest
            }
        }
    } catch {
        Write-Host "  âš ï¸  API error: $($_.Exception.Message)" -ForegroundColor Red
    }

    return $null
}

#endregion

#region Version Compatibility Check

function Test-VersionCompatibility {
    param([object]$Matrix)

    Write-Host "ğŸ”— Checking version compatibility..." -ForegroundColor Yellow

    $issues = @()

    # Get current versions from server
    $currentVersions = @{}

    # N8N
    $n8nVersion = ssh -i $SSHKey $ServerSSH "docker inspect easyway-orchestrator --format '{{.Config.Image}}' | cut -d: -f2" 2>$null
    if ($n8nVersion) { $currentVersions['n8n'] = $n8nVersion }

    # PostgreSQL
    $pgVersion = ssh -i $SSHKey $ServerSSH "docker inspect easyway-meta-db --format '{{.Config.Image}}' | grep -oP '(?<=:)\d+\.\d+'" 2>$null
    if ($pgVersion) { $currentVersions['postgres'] = $pgVersion }

    # Qdrant
    $qdrantVersion = ssh -i $SSHKey $ServerSSH "docker inspect easyway-memory --format '{{.Config.Image}}' | cut -d: -f2" 2>$null
    if ($qdrantVersion) { $currentVersions['qdrant'] = $qdrantVersion }

    # Traefik
    $traefikVersion = ssh -i $SSHKey $ServerSSH "docker inspect easyway-gateway --format '{{.Config.Image}}' | cut -d: -f2" 2>$null
    if ($traefikVersion) { $currentVersions['traefik'] = $traefikVersion }

    Write-Host "  Current versions:" -ForegroundColor Gray
    $currentVersions.GetEnumerator() | ForEach-Object {
        Write-Host "    $($_.Key): $($_.Value)" -ForegroundColor Gray
    }

    # Check N8N compatibility
    if ($currentVersions.ContainsKey('n8n')) {
        $n8nRules = $Matrix.compatibility_rules.n8n.'1.123.20'

        # Check PostgreSQL requirement
        if ($currentVersions.ContainsKey('postgres')) {
            $pgVersion = [version]$currentVersions['postgres']
            $pgMin = [version]$n8nRules.requires.postgres.min

            if ($pgVersion -lt $pgMin) {
                $issues += @{
                    severity = 'HIGH'
                    component = 'n8n â†’ postgres'
                    issue = "PostgreSQL version $pgVersion is below minimum required $pgMin"
                    recommendation = "Upgrade PostgreSQL to $($n8nRules.requires.postgres.recommended)"
                }
            }
        }

        # Check Qdrant compatibility
        if ($currentVersions.ContainsKey('qdrant')) {
            $qdrantVersion = $currentVersions['qdrant'] -replace 'v', ''
            $qdrantMin = $n8nRules.compatible_with.qdrant.min -replace 'v', ''

            if ([version]$qdrantVersion -lt [version]$qdrantMin) {
                $issues += @{
                    severity = 'MEDIUM'
                    component = 'n8n â†’ qdrant'
                    issue = "Qdrant $qdrantVersion may have compatibility issues"
                    recommendation = "Upgrade Qdrant to $($n8nRules.compatible_with.qdrant.tested[0])"
                }
            }
        }
    }

    # Check Traefik Docker API compatibility
    if ($currentVersions.ContainsKey('traefik')) {
        $dockerVersion = ssh -i $SSHKey $ServerSSH "docker version --format '{{.Server.APIVersion}}'" 2>$null

        if ($dockerVersion) {
            $traefikRules = $Matrix.compatibility_rules.traefik.'2.10'
            $minRequired = $traefikRules.requires.docker_api.actual_requirement

            if ([version]$dockerVersion -ge [version]'1.52') {
                $issues += @{
                    severity = 'CRITICAL'
                    component = 'traefik â†’ docker_engine'
                    issue = $traefikRules.requires.docker_api.issue
                    recommendation = "Migrate to Caddy or Nginx (see compatibility-matrix.json migration paths)"
                    current_state = @{
                        traefik_embedded_client = '1.24'
                        docker_engine_api = $dockerVersion
                        minimum_required = $minRequired
                    }
                }
            }
        }
    }

    return $issues
}

#endregion

#region NPM Audit

function Invoke-NPMAudit {
    param([string]$ProjectPath)

    Write-Host "ğŸ“¦ Running NPM audit on $ProjectPath..." -ForegroundColor Yellow

    $packageJson = Join-Path $ProjectPath 'package.json'
    if (-not (Test-Path $packageJson)) {
        Write-Host "  â„¹ï¸  No package.json found" -ForegroundColor Gray
        return @()
    }

    try {
        Push-Location $ProjectPath
        $auditResult = npm audit --json 2>$null | ConvertFrom-Json
        Pop-Location

        $vulnerabilities = @()

        if ($auditResult.vulnerabilities) {
            foreach ($vuln in $auditResult.vulnerabilities.PSObject.Properties) {
                $v = $vuln.Value
                $vulnerabilities += @{
                    package = $vuln.Name
                    severity = $v.severity.ToUpper()
                    title = $v.via[0].title
                    url = $v.via[0].url
                }
            }
        }

        return $vulnerabilities
    } catch {
        Write-Host "  âš ï¸  NPM audit failed: $($_.Exception.Message)" -ForegroundColor Red
        return @()
    }
}

#endregion

#region Main Execution

Write-Host ""
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  SCAN START" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# 1. EOL Monitoring
Write-Host "1ï¸âƒ£  EOL Status Check" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

$eolChecks = @(
    @{ product = 'postgres'; version = '15' },
    @{ product = 'gitlab'; version = '17.8' },
    @{ product = 'traefik'; version = '2.10' },
    @{ product = 'nginx'; version = '1.25' }
)

foreach ($check in $eolChecks) {
    $eolStatus = Get-EOLStatus -Product $check.product -Version $check.version
    if ($eolStatus) {
        $scanResults.eol_warnings += $eolStatus

        $color = 'Green'
        if ($eolStatus.days_remaining -lt 30) { $color = 'Red' }
        elseif ($eolStatus.days_remaining -lt 90) { $color = 'Yellow' }

        Write-Host "  $($check.product): " -NoNewline
        Write-Host "$($eolStatus.days_remaining) days until EOL" -ForegroundColor $color

        # Add to findings if critical
        if ($eolStatus.days_remaining -lt 30) {
            $scanResults.findings.high += @{
                type = 'EOL_WARNING'
                component = $check.product
                message = "Reaches EOL in $($eolStatus.days_remaining) days"
                eol_date = $eolStatus.eol_date
            }
        }
    }
}

Write-Host ""

# 2. Version Compatibility
Write-Host "2ï¸âƒ£  Version Compatibility Check" -ForegroundColor Cyan
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

$compatIssues = Test-VersionCompatibility -Matrix $compatibilityMatrix

foreach ($issue in $compatIssues) {
    $scanResults.compatibility_issues += $issue

    $color = switch ($issue.severity) {
        'CRITICAL' { 'Red' }
        'HIGH' { 'Yellow' }
        'MEDIUM' { 'Cyan' }
        default { 'Gray' }
    }

    Write-Host "  [$($issue.severity)] " -ForegroundColor $color -NoNewline
    Write-Host "$($issue.component): $($issue.issue)"
    Write-Host "    â†’ $($issue.recommendation)" -ForegroundColor Gray

    # Add to findings
    $scanResults.findings.($issue.severity.ToLower()) += @{
        type = 'COMPATIBILITY_ISSUE'
        component = $issue.component
        message = $issue.issue
        recommendation = $issue.recommendation
    }
}

Write-Host ""

# 3. NPM Audit
if ($Mode -eq 'full') {
    Write-Host "3ï¸âƒ£  NPM Dependency Audit" -ForegroundColor Cyan
    Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

    $npmProjects = @(
        (Join-Path $ProjectRoot 'apps\portal-frontend'),
        (Join-Path $ProjectRoot 'portal-api')
    )

    foreach ($project in $npmProjects) {
        if (Test-Path $project) {
            $vulns = Invoke-NPMAudit -ProjectPath $project

            if ($vulns.Count -gt 0) {
                Write-Host "  $($project): $($vulns.Count) vulnerabilities found" -ForegroundColor Yellow

                foreach ($v in $vulns) {
                    $scanResults.findings.($v.severity.ToLower()) += @{
                        type = 'NPM_VULNERABILITY'
                        package = $v.package
                        message = $v.title
                        url = $v.url
                    }
                }
            } else {
                Write-Host "  $($project): âœ… No vulnerabilities" -ForegroundColor Green
            }
        }
    }

    Write-Host ""
}

# 4. Summary
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  SCAN SUMMARY" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

$scanResults.summary.critical_count = $scanResults.findings.critical.Count
$scanResults.summary.high_count = $scanResults.findings.high.Count
$scanResults.summary.medium_count = $scanResults.findings.medium.Count
$scanResults.summary.low_count = $scanResults.findings.low.Count
$scanResults.summary.total_issues = $scanResults.summary.critical_count +
                                     $scanResults.summary.high_count +
                                     $scanResults.summary.medium_count +
                                     $scanResults.summary.low_count

Write-Host "ğŸ”´ CRITICAL: $($scanResults.summary.critical_count)" -ForegroundColor Red
Write-Host "ğŸŸ¡ HIGH:     $($scanResults.summary.high_count)" -ForegroundColor Yellow
Write-Host "ğŸŸ  MEDIUM:   $($scanResults.summary.medium_count)" -ForegroundColor Cyan
Write-Host "âšª LOW:      $($scanResults.summary.low_count)" -ForegroundColor Gray
Write-Host ""
Write-Host "Total Issues: $($scanResults.summary.total_issues)" -ForegroundColor $(if ($scanResults.summary.critical_count -gt 0) { 'Red' } elseif ($scanResults.summary.high_count -gt 0) { 'Yellow' } else { 'Green' })

#endregion

#region Output Generation

if (-not $DryRun) {
    Write-Host ""
    Write-Host "ğŸ“ Generating reports..." -ForegroundColor Cyan

    # JSON output
    $jsonPath = Join-Path $WikiDir "security\vulnerability-scan-$(Get-Date -Format 'yyyy-MM-dd').json"
    $scanResults | ConvertTo-Json -Depth 10 | Out-File $jsonPath -Encoding UTF8
    Write-Host "  âœ… JSON: $jsonPath" -ForegroundColor Green

    # Markdown report
    if ($OutputFormat -eq 'markdown') {
        $mdPath = Join-Path $WikiDir "security\vulnerability-scan-$(Get-Date -Format 'yyyy-MM-dd').md"

        $markdown = @"
# ğŸ›¡ï¸ Security Vulnerability Scan Report

**Date:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
**Mode:** $Mode
**Status:** $(if ($scanResults.summary.critical_count -gt 0) { 'ğŸ”´ CRITICAL ISSUES FOUND' } elseif ($scanResults.summary.high_count -gt 0) { 'ğŸŸ¡ HIGH PRIORITY' } else { 'ğŸŸ¢ HEALTHY' })

---

## ğŸ“Š Summary

| Severity | Count |
|----------|-------|
| ğŸ”´ CRITICAL | $($scanResults.summary.critical_count) |
| ğŸŸ¡ HIGH | $($scanResults.summary.high_count) |
| ğŸŸ  MEDIUM | $($scanResults.summary.medium_count) |
| âšª LOW | $($scanResults.summary.low_count) |
| **TOTAL** | **$($scanResults.summary.total_issues)** |

---

## ğŸ”— Version Compatibility Issues

"@

        if ($scanResults.compatibility_issues.Count -gt 0) {
            foreach ($issue in $scanResults.compatibility_issues) {
                $markdown += @"

### [$($issue.severity)] $($issue.component)

**Issue:** $($issue.issue)

**Recommendation:** $($issue.recommendation)

---
"@
            }
        } else {
            $markdown += "`nâœ… No compatibility issues detected`n"
        }

        $markdown += @"

## ğŸ“… EOL Warnings

"@

        if ($scanResults.eol_warnings.Count -gt 0) {
            $markdown += @"
| Product | Version | Days Until EOL | EOL Date |
|---------|---------|----------------|----------|
"@
            foreach ($eol in $scanResults.eol_warnings) {
                $markdown += "`n| $($eol.product) | $($eol.version) | $($eol.days_remaining) | $($eol.eol_date) |"
            }
        } else {
            $markdown += "`nâœ… No EOL warnings`n"
        }

        $markdown | Out-File $mdPath -Encoding UTF8
        Write-Host "  âœ… Markdown: $mdPath" -ForegroundColor Green
    }
}

Write-Host ""
Write-Host "âœ… Scan completed successfully!" -ForegroundColor Green

# Exit code based on severity
if ($scanResults.summary.critical_count -gt 0) {
    exit 2
} elseif ($scanResults.summary.high_count -gt 0) {
    exit 1
} else {
    exit 0
}

#endregion

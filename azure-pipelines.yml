trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: EasyWay-Secrets  # Variable Group in ADO with AZURE_STORAGE_* and DB creds
  - name: node_version
    value: '20.x'
  - name: workingDirectory
    value: 'EasyWay-DataPortal/easyway-portal-api'

stages:
  - stage: Infra
    displayName: Terraform Plan/Apply
    jobs:
      - job: TerraformPlan
        displayName: Terraform Validate & Plan
        steps:
          - task: PowerShell@2
            displayName: 'Check Variable Group / Required Vars'
            inputs:
              targetType: 'inline'
              script: |
                $required = @('RESOURCE_GROUP_NAME','STORAGE_ACCOUNT_NAME','TENANTS')
                $missing = @()
                foreach ($k in $required) {
                  $val = [Environment]::GetEnvironmentVariable($k)
                  if ([string]::IsNullOrWhiteSpace($val)) { $missing += $k }
                }
                if ($missing.Count -gt 0) {
                  Write-Error "Missing required pipeline variables: $($missing -join ', ')";
                  Write-Host "Hint: link Variable Group 'EasyWay-Secrets' or define these variables at pipeline level.";
                  exit 1
                } else {
                  Write-Host "Required variables found: $($required -join ', ')"
                }
          - script: |
              cd infra/terraform
              terraform -version || true
              echo "Initializing..."
              terraform init -input=false
              echo "Validating..."
              terraform validate
              echo "Planning..."
              terraform plan -input=false -out=tfplan \
                -var "project_name=easyway" \
                -var "resource_group_name=$(RESOURCE_GROUP_NAME)" \
                -var "storage_account_name=$(STORAGE_ACCOUNT_NAME)" \
                -var "tenants=$(TENANTS)"
            displayName: 'Terraform init/validate/plan'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: tfplan'
            inputs:
              PathtoPublish: 'infra/terraform/tfplan'
              ArtifactName: 'tfplan'

      - job: TerraformApply
        displayName: Terraform Apply (main only)
        dependsOn: TerraformPlan
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
        steps:
          - script: |
              cd infra/terraform
              terraform init -input=false
              terraform apply -input=false -auto-approve tfplan || echo "Provide manual apply if needed"
            displayName: 'Terraform apply'

  - stage: BuildAndTest
    displayName: Build, Lint, Test
    jobs:
      - job: NodeBuild
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'

          - script: |
              cd $(workingDirectory)
              npm ci
              npm run build
            displayName: 'Install & Build'

          - script: |
              cd $(workingDirectory)
              npm run lint
            displayName: 'Lint'

          - script: |
              cd $(workingDirectory)
              npm test -- --ci --reporters=default
            displayName: 'Test'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: api-dist'
            inputs:
              PathtoPublish: '$(workingDirectory)/dist'
              ArtifactName: 'api-dist'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: openapi'
            inputs:
              PathtoPublish: '$(workingDirectory)/openapi'
              ArtifactName: 'openapi'

      - job: WikiLint
        displayName: 'Wiki Normalize & Lint'
        steps:
          - task: PowerShell@2
            displayName: 'Normalize & Review Wiki (if scripts exist)'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Running Wiki normalize/lint if available..."
                $scripts = "Wiki/EasyWayData.wiki/scripts"
                if (Test-Path $scripts) {
                  if (Test-Path "$scripts/normalize-project.ps1") {
                    pwsh "$scripts/normalize-project.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                  if (Test-Path "$scripts/review-run.ps1") {
                    pwsh "$scripts/review-run.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                } else {
                  Write-Host "Wiki scripts folder not found, skipping."
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-logs'
            inputs:
              PathtoPublish: 'Wiki/EasyWayData.wiki/logs'
              ArtifactName: 'wiki-logs'
            condition: and(succeeded(), exists('Wiki/EasyWayData.wiki/logs'))

      - job: PreDeployChecklist
        displayName: 'Pre-Deploy Checklist (Gate)'
        dependsOn:
          - NodeBuild
          - WikiLint
        steps:
          - task: PowerShell@2
            displayName: 'Run Checklist Bot'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                $env:CHECKLIST_OUTPUT = 'json'
                Write-Host "Running checklist..."
                $out = npm run -s check:predeploy
                $out | Out-File -FilePath checklist.json -Encoding utf8
                $json = Get-Content checklist.json -Raw | ConvertFrom-Json
                if (-not $json.summary.ok) {
                  Write-Host "Checklist FAILED"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "Checklist failed"
                } else {
                  Write-Host "Checklist OK"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: checklist'
            inputs:
              PathtoPublish: '$(workingDirectory)/checklist.json'
              ArtifactName: 'checklist'

      - job: DBDriftCheck
        displayName: 'DB Drift Check (Gate)'
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Run DB Drift Check'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                Write-Host "Running DB drift check..."
                $out = npm run -s db:drift
                $out | Out-File -FilePath drift.json -Encoding utf8
                $json = Get-Content drift.json -Raw | ConvertFrom-Json
                if (-not $json.ok) {
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "DB drift check failed (missing objects)"
                } else {
                  Write-Host "DB drift check OK"
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: db-drift'
            inputs:
              PathtoPublish: '$(workingDirectory)/drift.json'
              ArtifactName: 'db-drift'

  # Future: add Deploy stage(s) with environments, approvals, and secret handling
  # - stage: Deploy
  #   dependsOn: BuildAndTest
  #   jobs:
  #     - job: DeployToDev
  #       steps: []

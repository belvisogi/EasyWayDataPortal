trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: Default

variables:
  - template: ci/versions.yml
  - group: EasyWay-Secrets  # Variable Group in ADO with AZURE_STORAGE_* and  # Path API
  - name: API_PATH
    value: 'portal-api/easyway-portal-api'
  - name: ENABLE_ORCHESTRATOR
    value: 'true'
  - name: ORCHESTRATOR_INTENT
    value: 'governance-predeploy'
  - name: USE_EWCTL_GATES
    value: 'true'
  - name: ENABLE_CHECKLIST
    value: 'true'
  - name: ENABLE_DB_DRIFT
    value: 'true'
  - name: ENABLE_KB_CONSISTENCY
    value: 'true'
  - name: ENABLE_WIKI_LLM_LINT
    value: 'true'
  - name: WIKI_LLM_LINT_PATH
    value: 'Wiki/EasyWayData.wiki'
  - name: ENABLE_WIKI_TAGS_LINT
    value: 'true'
  - name: ENABLE_WIKI_LINKS_ANCHORS_LINT
    value: 'true'
  - name: ENABLE_WIKI_SUMMARY_LINT
    value: 'true'
  - name: ENABLE_WIKI_INDEX_LINT
    value: 'true'
  - name: ENABLE_WIKI_GAP_REPORT
    value: 'true'
  - name: WIKI_GAP_MODE
    value: 'phased' # phased | all
  - name: ENABLE_WHATFIRST_LINT
    value: 'true'
  - name: ENVIRONMENT
    value: 'dev'
  - name: GOV_APPROVED
    value: 'false'

stages:
  - stage: PreChecks
    displayName: Pre-Checks (Guardrails)
    jobs:
      - job: BranchPolicyGuard
        displayName: 'Branch Naming + Target Policy Guard (PR)'
        condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Validate PR source/target against guard policy'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)

                $sourceRef = "$env:SYSTEM_PULLREQUEST_SOURCEBRANCH"
                $targetRef = "$env:SYSTEM_PULLREQUEST_TARGETBRANCH"
                if ([string]::IsNullOrWhiteSpace($sourceRef) -or [string]::IsNullOrWhiteSpace($targetRef)) {
                  throw "PR variables missing. Source='$sourceRef' Target='$targetRef'"
                }

                $source = $sourceRef -replace '^refs/heads/', ''
                $target = $targetRef -replace '^refs/heads/', ''
                Write-Host "Guard check: $source -> $target"

                pwsh scripts/pwsh/agent-guard.ps1 -ContextId "PR-$(System.PullRequest.PullRequestId)" -SourceBranch $source -TargetBranch $target

      - job: SourceSyncGuard
        displayName: 'Source Branch Sync Guard (PR) [warn-only]'
        condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
        continueOnError: true
        steps:
          - task: PowerShell@2
            displayName: 'Check source is not behind target (warn-only, non-blocking)'
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Continue'
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)

                $source = "$env:SYSTEM_PULLREQUEST_SOURCEBRANCH" -replace '^refs/heads/', ''
                $target = "$env:SYSTEM_PULLREQUEST_TARGETBRANCH" -replace '^refs/heads/', ''
                Write-Host "Sync guard: checking if '$source' is up-to-date with '$target'"

                git fetch origin $target 2>&1 | Out-Null
                git fetch origin $source 2>&1 | Out-Null

                $commonAncestor = git merge-base "origin/$source" "origin/$target"
                $targetHead     = git rev-parse "origin/$target"

                if ($commonAncestor -ne $targetHead) {
                  $behind = git rev-list --count "origin/$source..origin/$target"
                  Write-Host ""
                  Write-Host "##[warning]SYNC ADVISORY: '$source' is $behind commit(s) behind '$target'."
                  Write-Host "##[warning]This PR may be missing recent changes from '$target'."
                  Write-Host ""
                  Write-Host "If intentional (cherry-pick, hotfix): proceed as-is."
                  Write-Host "If not intentional, fix options:"
                  Write-Host "  SYNC:   git fetch origin && git merge origin/$target"
                  Write-Host "  REBASE: git fetch origin && git rebase origin/$target"
                  Write-Host ""
                  # warn only — do not exit 1, human decides
                  exit 0
                }

                Write-Host "OK: '$source' is up-to-date with '$target'." -ForegroundColor Green

      - job: EnforcerCheck
        displayName: 'Allowed Paths Enforcer (agents)'
        condition: eq(variables['Build.Reason'], 'PullRequest')
        steps:
          - task: PowerShell@2
            displayName: 'Run enforcer for agents (git diff)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                echo "== Enforcer: agent_governance =="
                pwsh scripts/pwsh/enforcer.ps1 -Agent agent_governance -GitDiff
                echo "== Enforcer: agent_docs_review =="
                pwsh scripts/pwsh/enforcer.ps1 -Agent agent_docs_review -GitDiff
                echo "== Enforcer: agent_pr_manager =="
                pwsh scripts/pwsh/enforcer.ps1 -Agent agent_pr_manager -GitDiff
      - job: WikiFrontmatterLint
        displayName: 'Wiki LLM Front-Matter Lint (Phased scopes)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_LLM_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-frontmatter-lint (phased, fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                # Phased rollout: lint frontmatter only on curated scopes, to prevent regressions while we fix legacy pages.
                pwsh -NoProfile -Command "New-Item -ItemType Directory -Force -Path 'wiki-frontmatter-lint' | Out-Null"
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-datalake-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.db-datalake-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.portal-api-frontend-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName controlplane-governance-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.controlplane-governance-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName argos-dq-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.argos-dq-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName ops-runbooks-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.ops-runbooks-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName frontend-ui-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.frontend-ui-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-programmability-rest-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.db-programmability-rest-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName onboarding-runbook-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.onboarding-runbook-20.json'
                pwsh scripts/wiki-frontmatter-lint.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName iam-security-20 -FailOnError -SummaryOut 'wiki-frontmatter-lint/wiki-frontmatter-lint.iam-security-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-frontmatter-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/wiki-frontmatter-lint'
              ArtifactName: 'wiki-frontmatter-lint'
      - job: WikiTagsLintPhased
        displayName: 'Wiki Tag Taxonomy Lint (Phased scopes)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_TAGS_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-tags-lint (phased, fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                # Enforce the controlled tag taxonomy on curated scopes (phased rollout)
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName db-datalake-20 -FailOnError -SummaryOut 'wiki-tags-lint.db-datalake-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-tags-lint.portal-api-frontend-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName controlplane-governance-20 -FailOnError -SummaryOut 'wiki-tags-lint.controlplane-governance-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName argos-dq-20 -FailOnError -SummaryOut 'wiki-tags-lint.argos-dq-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName ops-runbooks-20 -FailOnError -SummaryOut 'wiki-tags-lint.ops-runbooks-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName frontend-ui-20 -FailOnError -SummaryOut 'wiki-tags-lint.frontend-ui-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName db-programmability-rest-20 -FailOnError -SummaryOut 'wiki-tags-lint.db-programmability-rest-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName onboarding-runbook-20 -FailOnError -SummaryOut 'wiki-tags-lint.onboarding-runbook-20.json'
                pwsh scripts/wiki-tags-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports -RequireFacets -RequireFacetsScope core -ScopeName iam-security-20 -FailOnError -SummaryOut 'wiki-tags-lint.iam-security-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-tags-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)'
              ArtifactName: 'wiki-tags-lint'
      - job: WikiLinksAnchorsLintPhased
        displayName: 'Wiki Links + Anchors Lint (Phased scopes)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_LINKS_ANCHORS_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-links-anchors-lint (phased, fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                pwsh -NoProfile -Command "New-Item -ItemType Directory -Force -Path 'wiki-links-anchors-lint' | Out-Null"
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-datalake-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.db-datalake-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.portal-api-frontend-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName controlplane-governance-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.controlplane-governance-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName argos-dq-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.argos-dq-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName ops-runbooks-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.ops-runbooks-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName frontend-ui-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.frontend-ui-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-programmability-rest-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.db-programmability-rest-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName onboarding-runbook-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.onboarding-runbook-20.json'
                pwsh scripts/wiki-links-anchors-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName iam-security-20 -FailOnError -SummaryOut 'wiki-links-anchors-lint/wiki-links-anchors-lint.iam-security-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-links-anchors-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/wiki-links-anchors-lint'
              ArtifactName: 'wiki-links-anchors-lint'
      - job: WikiSummaryLintPortalApiFrontend
        displayName: 'Wiki Summary Lint (portal-api-frontend-20)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_SUMMARY_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-summary-lint (fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                pwsh scripts/wiki-summary-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-summary-lint.portal-api-frontend-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-summary-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/wiki-summary-lint.portal-api-frontend-20.json'
              ArtifactName: 'wiki-summary-lint'
      - job: WikiIndexLint
        displayName: 'Wiki Index Lint (Phased scopes)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_INDEX_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-index-lint (phased, fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                pwsh -NoProfile -Command "New-Item -ItemType Directory -Force -Path 'wiki-index-lint' | Out-Null"
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-datalake-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.db-datalake-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.portal-api-frontend-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName controlplane-governance-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.controlplane-governance-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName argos-dq-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.argos-dq-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName ops-runbooks-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.ops-runbooks-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName frontend-ui-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.frontend-ui-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-programmability-rest-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.db-programmability-rest-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName onboarding-runbook-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.onboarding-runbook-20.json'
                pwsh scripts/wiki-index-lint.ps1 -Path 'Wiki/EasyWayData.wiki' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName iam-security-20 -FailOnError -SummaryOut 'wiki-index-lint/wiki-index-lint.iam-security-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-index-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/wiki-index-lint'
              ArtifactName: 'wiki-index-lint'
      - job: WikiGapReport
        displayName: 'Wiki Gap Report (Phased scopes)'
        condition: and(succeeded(), eq(variables['ENABLE_WIKI_GAP_REPORT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run wiki-gap-report (phased/all, fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                pwsh -NoProfile -Command "New-Item -ItemType Directory -Force -Path 'wiki-gap-report' | Out-Null"

                if ('$(WIKI_GAP_MODE)' -eq 'all') {
                  pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName '' -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.all.json'
                  exit 0
                }

                # Default: phased rollout on curated scopes (same set as wiki-frontmatter/tags/links lints).
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-datalake-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.db-datalake-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName portal-api-frontend-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.portal-api-frontend-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName controlplane-governance-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.controlplane-governance-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName argos-dq-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.argos-dq-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName ops-runbooks-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.ops-runbooks-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName frontend-ui-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.frontend-ui-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName db-programmability-rest-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.db-programmability-rest-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName onboarding-runbook-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.onboarding-runbook-20.json'
                pwsh scripts/wiki-gap-report.ps1 -Path '$(WIKI_LLM_LINT_PATH)' -ExcludePaths logs/reports,old,.attachments -ScopesPath 'docs/agentic/templates/docs/tag-taxonomy.scopes.json' -ScopeName iam-security-20 -FailOnError -SummaryOut 'wiki-gap-report/wiki-gap.iam-security-20.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-gap-report'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/wiki-gap-report'
              ArtifactName: 'wiki-gap-report'
      - job: WhatFirstLint
        displayName: 'WHAT-first + Diary Lint (manifests/intents/ux_prompts)'
        condition: and(succeeded(), eq(variables['ENABLE_WHATFIRST_LINT'], 'true'), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - task: PowerShell@2
            displayName: 'Run whatfirst-lint (fail on error)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                pwsh scripts/whatfirst-lint.ps1 -FailOnError -SummaryOut 'whatfirst-lint.json'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: whatfirst-lint'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/whatfirst-lint.json'
              ArtifactName: 'whatfirst-lint'
      - job: DocAlignmentCheck
        displayName: 'Doc Alignment Gate (manifests ↔ intent ↔ KB ↔ Wiki)'
        condition: and(succeeded(), eq(variables['ENABLE_DOC_ALIGNMENT'], 'true'))
        steps:
          - task: PowerShell@2
            displayName: 'Run doc-alignment-check (mandatory only fails)'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                $res = pwsh scripts/doc-alignment-check.ps1 -FailOnError
                Write-Host $res
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: doc-alignment-report'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/agents/kb/recipes.jsonl'
              ArtifactName: 'doc-alignment-context'
  - stage: BuildAndTest
    displayName: Build, Lint, Test
    dependsOn: PreChecks
    jobs:
      - job: EventsSchemaValidate
        displayName: 'Events JSON Schema Validation (ARGOS)'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'
          - script: |
              set -e
              node scripts/validate-event-schemas.mjs | tee event-schema-validate.log
            displayName: 'Validate event schemas (1:1 schema↔sample)'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: event-schema-validate'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/event-schema-validate.log'
              ArtifactName: 'event-schema-validate'
      - job: GovernanceGatesEWCTL
        displayName: 'Governance Gates via ewctl (Checklist/Drift/KB)'
        condition: and(succeeded(), eq(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Run ewctl gates (Sacred Path) + logevent'
            inputs:
              targetType: 'inline'
              script: |
                # Sacred Path: Use the root wrapper with the check verb and JSON output
                pwsh ewctl.ps1 check -Json
      - job: Orchestrator
        displayName: 'Orchestrator (Plan)'
        condition: and(succeeded(), eq(variables['ENABLE_ORCHESTRATOR'], 'true'))
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'
          - task: PowerShell@2
            displayName: 'Generate orchestrator plan (TS engine)'
            inputs:
              targetType: 'inline'
              script: |
                # Direct call to Node.js orchestrator (bypassing ewctl middleware for raw access)
                node agents/core/orchestrator.js --intent "$(ORCHESTRATOR_INTENT)" --noninteractive --logevent > orchestrator-plan.json
                Write-Host "Plan written to orchestrator-plan.json"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: orchestrator-plan'
            inputs:
              PathtoPublish: 'orchestrator-plan.json'
              ArtifactName: 'orchestrator-plan'
      - job: VersionsReport
        displayName: 'Versions Report (Node/Flyway/Terraform)'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'
          - script: |
              set -e
              REPORT_FILE="$(Build.SourcesDirectory)/versions-report.txt"
              echo "Configured versions (from ci/versions.yml):"           | tee "$REPORT_FILE"
              echo "  node_version=$(node_version)"                        | tee -a "$REPORT_FILE"
              echo "  flyway_version=$(flyway_version)"                    | tee -a "$REPORT_FILE"
              echo "  terraform_version=$(terraform_version)"              | tee -a "$REPORT_FILE"
              echo ""                                                      | tee -a "$REPORT_FILE"
              echo "Detected Node & npm versions:"                         | tee -a "$REPORT_FILE"
              node -v                                                       | tee -a "$REPORT_FILE"
              npm -v                                                        | tee -a "$REPORT_FILE"
            displayName: 'Report Node/npm versions'
          - script: |
              set -e
              FLYWAY_VERSION=$(flyway_version)
              echo "Installing Flyway ${FLYWAY_VERSION} for version check..."
              curl -sSL -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz
              tar -xzf /tmp/flyway.tar.gz -C /tmp >/dev/null 2>&1 || true
              echo "##vso[task.prependpath]/tmp/flyway-${FLYWAY_VERSION}"
              flyway -v || true | tee -a "$(Build.SourcesDirectory)/versions-report.txt"
            displayName: 'Report Flyway version'
          - script: |
              set -e
              TF_VERSION=$(terraform_version)
              echo "Installing Terraform ${TF_VERSION} for version check..."
              curl -sSL -o /tmp/terraform.zip https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
              unzip -o /tmp/terraform.zip -d /tmp >/dev/null 2>&1 || true
              echo "##vso[task.prependpath]/tmp"
              terraform version || true | tee -a "$(Build.SourcesDirectory)/versions-report.txt"
            displayName: 'Report Terraform version'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: versions-report'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/versions-report.txt'
              ArtifactName: 'versions-report'
      - job: NodeBuild
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'

          - script: |
              cd $(workingDirectory)
              npm ci
              npm run build
            displayName: 'Install & Build'

          - script: |
              cd $(workingDirectory)
              npm run lint
            displayName: 'Lint'

          - script: |
              cd $(workingDirectory)
              npm test -- --ci --reporters=default
            displayName: 'Test'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: api-dist'
            inputs:
              PathtoPublish: '$(workingDirectory)/dist'
              ArtifactName: 'api-dist'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: openapi'
            inputs:
              PathtoPublish: '$(workingDirectory)/openapi'
              ArtifactName: 'openapi'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: agent-kb'
            inputs:
              PathtoPublish: 'agents/kb'
              ArtifactName: 'agent-kb'

      - job: WikiLint
        displayName: 'Wiki Normalize & Lint'
        steps:
          - task: PowerShell@2
            displayName: 'Normalize & Review Wiki (if scripts exist)'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Running Wiki normalize/lint if available..."
                $scripts = "Wiki/EasyWayData.wiki/scripts"
                if (Test-Path $scripts) {
                  if (Test-Path "$scripts/normalize-project.ps1") {
                    pwsh "$scripts/normalize-project.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                  if (Test-Path "$scripts/review-run.ps1") {
                    pwsh "$scripts/review-run.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                } else {
                  Write-Host "Wiki scripts folder not found, skipping."
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-logs'
            inputs:
              PathtoPublish: 'Wiki/EasyWayData.wiki/logs'
              ArtifactName: 'wiki-logs'
            condition: and(succeeded(), exists('Wiki/EasyWayData.wiki/logs'))

      - job: PreDeployChecklist
        displayName: 'Pre-Deploy Checklist (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_CHECKLIST'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
          - WikiLint
        steps:
          - task: PowerShell@2
            displayName: 'Run Checklist Bot'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                $env:CHECKLIST_OUTPUT = 'json'
                Write-Host "Running checklist..."
                $out = npm run -s check:predeploy
                $out | Out-File -FilePath checklist.json -Encoding utf8
                $json = Get-Content checklist.json -Raw | ConvertFrom-Json
                if (-not $json.summary.ok) {
                  Write-Host "Checklist FAILED"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "Checklist failed"
                } else {
                  Write-Host "Checklist OK"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: checklist'
            inputs:
              PathtoPublish: '$(workingDirectory)/checklist.json'
              ArtifactName: 'checklist'

      - job: KBConsistency
        displayName: 'KB Consistency (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_KB_CONSISTENCY'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Verify KB/Wiki updated (DB/API + ADO scripts + agents docs)'
            inputs:
              targetType: 'inline'
              script: |
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                try { $base = (git rev-parse HEAD~1) } catch { Write-Host "Shallow repo; skipping KB Consistency check (first run)"; exit 0 }
                $changed = git diff --name-only $base HEAD
                $changedDbApi = $false
                $changedAdoScripts = $false
                $changedAgentsDocs = $false
                foreach ($f in $changed) {
                  if ($f -like 'db/*' -or $f -like 'portal-api/easyway-portal-api/src/*') { $changedDbApi = $true }
                  if ($f -like 'scripts/ado/*') { $changedAdoScripts = $true }
                  if ($f -like 'Wiki/EasyWayData.wiki/agents-*.md') { $changedAgentsDocs = $true }
                }
                if (-not ($changedDbApi -or $changedAdoScripts -or $changedAgentsDocs)) {
                  Write-Host "No relevant changes (DB/API/ADO scripts/agents docs); KB not required"; exit 0 }
                $kbChanged = $false; $wikiChanged = $false
                foreach ($f in $changed) {
                  if ($f -eq 'agents/kb/recipes.jsonl') { $kbChanged = $true }
                  if ($f -like 'Wiki/*') { $wikiChanged = $true }
                }
                if ($changedDbApi -and (-not $kbChanged -or -not $wikiChanged)) {
                  Write-Error "KB Consistency failed: when DB/API changes, update agents/kb/recipes.jsonl and at least one Wiki page."
                  exit 1
                }
                if (($changedAdoScripts -or $changedAgentsDocs) -and (-not $kbChanged)) {
                  Write-Error "KB Consistency failed: changes in scripts/ado/** or Wiki/agents-*.md require updating agents/kb/recipes.jsonl (add/adjust a recipe)."
                  exit 1
                }
                Write-Host "KB Consistency OK"

      - job: DBDriftCheck
        displayName: 'DB Drift Check (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_DB_DRIFT'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Run DB Drift Check'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                Write-Host "Running DB drift check..."
                $out = npm run -s db:drift
                $out | Out-File -FilePath drift.json -Encoding utf8
                $json = Get-Content drift.json -Raw | ConvertFrom-Json
                if (-not $json.ok) {
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "DB drift check failed (missing objects)"
                } else {
                  Write-Host "DB drift check OK"
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: db-drift'
            inputs:
              PathtoPublish: '$(workingDirectory)/drift.json'
              ArtifactName: 'db-drift'

      - job: ActivityLog
        displayName: 'Activity Log (Append + Update Wiki)'
        dependsOn:
          - PreDeployChecklist
          - KBConsistency
          - DBDriftCheck
        condition: succeededOrFailed()
        steps:
          - task: PowerShell@2
            displayName: 'Append activity event'
            inputs:
              targetType: 'inline'
              script: |
                $intent = 'pipeline-run'
                $actor = 'agent_governance'
                $env = 'ci'
                $outcome = '$(Agent.JobStatus)'
                $refs = @("branch=$(Build.SourceBranch)", "commit=$(Build.SourceVersion)", "build=$(Build.BuildNumber)")
                $artifacts = @()
                if (Test-Path "$(workingDirectory)/checklist.json") { $artifacts += 'checklist.json' }
                if (Test-Path "$(workingDirectory)/drift.json") { $artifacts += 'drift.json' }
                if (Test-Path "$(Build.SourcesDirectory)/versions-report.txt") { $artifacts += 'versions-report.txt' }
                if (Test-Path "$(Build.SourcesDirectory)/orchestrator-plan.json") { $artifacts += 'orchestrator-plan.json' }
                pwsh scripts/activity-log.ps1 -Intent $intent -Actor $actor -Env $env -Outcome $outcome -Refs $refs -Artifacts $artifacts -Notes "CI run"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: activity-log'
            inputs:
              PathtoPublish: 'agents/logs'
              ArtifactName: 'activity-log'

      - job: GatesReport
        displayName: 'Gates Report (aggregate)'
        dependsOn:
          - PreDeployChecklist
          - KBConsistency
          - DBDriftCheck
        condition: succeededOrFailed()
        steps:
          - task: PowerShell@2
            displayName: 'Generate gates-report.json'
            inputs:
              targetType: 'inline'
              script: |
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                $report = [ordered]@{
                  checklistEnabled = '$(ENABLE_CHECKLIST)';
                  kbConsistencyEnabled = '$(ENABLE_KB_CONSISTENCY)';
                  dbDriftEnabled = '$(ENABLE_DB_DRIFT)';
                  checklistOk = (Test-Path "$(workingDirectory)/checklist.json");
                  dbDriftOk = (Test-Path "$(workingDirectory)/drift.json");
                }
                $json = ($report | ConvertTo-Json -Depth 4)
                $out = Join-Path '$(Build.SourcesDirectory)' 'gates-report.json'
                $json | Set-Content -Encoding UTF8 $out
                Write-Host "Wrote $out"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: gates-report'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/gates-report.json'
              ArtifactName: 'gates-report'

# GitHub Mirror (main only) — push automatico dopo ogni merge su main
  - stage: GitHubMirror
    displayName: 'GitHub Mirror (publish main → github)'
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: MirrorToGitHub
        displayName: 'Push main → github.com/belvisogi/EasyWayDataPortal'
        pool:
          name: Default
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: false
          - script: |
              set -e
              git config user.email "ew-svc-azuredevops-agent@easyway.local"
              git config user.name "EasyWay CI"
              REMOTE="https://$(GITHUB_PAT)@github.com/belvisogi/EasyWayDataPortal.git"
              git push "$REMOTE" HEAD:main --force-with-lease
              echo "##[section]GitHub mirror: OK — $(git rev-parse --short HEAD)"
            displayName: 'git push → GitHub'
            env:
              GITHUB_PAT: $(GITHUB_PAT)

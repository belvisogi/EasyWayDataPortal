trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - template: ci/versions.yml
  - group: EasyWay-Secrets  # Variable Group in ADO with AZURE_STORAGE_* and DB creds
  - name: workingDirectory
    value: 'EasyWay-DataPortal/easyway-portal-api'
  - name: ENABLE_ORCHESTRATOR
    value: 'true'
  - name: ORCHESTRATOR_INTENT
    value: 'governance-predeploy'
  - name: USE_EWCTL_GATES
    value: 'true'
  - name: FLYWAY_ENABLED
    value: 'true'   # enable Flyway migrate in Dev/Test
  - name: ENABLE_CHECKLIST
    value: 'true'
  - name: ENABLE_DB_DRIFT
    value: 'true'
  - name: ENABLE_KB_CONSISTENCY
    value: 'true'
  - name: ENABLE_DEPLOY
    value: 'false'
  - name: ENABLE_SWAP
    value: 'false'
  - name: AZURE_SERVICE_CONNECTION
    value: ''
  - name: WEBAPP_NAME
    value: ''
  - name: RESOURCE_GROUP
    value: ''
  - name: WEBAPP_SLOT
    value: ''
  - name: ENABLE_SYNC_APPSETTINGS
    value: 'false'
  - name: ENVIRONMENT
    value: 'dev'
  - name: GOV_APPROVED
    value: 'false'
  # Expected (in Variable Group or pipeline vars): FLYWAY_URL, FLYWAY_USER, FLYWAY_PASSWORD

stages:
  - stage: PreChecks
    displayName: Pre-Checks (Guardrails)
    jobs:
      - job: EnforcerCheck
        displayName: 'Allowed Paths Enforcer (agents)'
        steps:
          - task: PowerShell@2
            displayName: 'Run enforcer for agents (git diff)'
            inputs:
              targetType: 'inline'
              script: |
                set -e
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                echo "== Enforcer: agent_governance =="
                pwsh scripts/enforcer.ps1 -Agent agent_governance -GitDiff
                echo "== Enforcer: agent_docs_review =="
                pwsh scripts/enforcer.ps1 -Agent agent_docs_review -GitDiff
                echo "== Enforcer: agent_pr_manager =="
                pwsh scripts/enforcer.ps1 -Agent agent_pr_manager -GitDiff
  - stage: Infra
    displayName: Terraform Plan/Apply
    jobs:
      - job: TerraformPlan
        displayName: Terraform Validate & Plan
        steps:
          - task: PowerShell@2
            displayName: 'Check Variable Group / Required Vars'
            inputs:
              targetType: 'inline'
              script: |
                $required = @('RESOURCE_GROUP_NAME','STORAGE_ACCOUNT_NAME','TENANTS')
                $missing = @()
                foreach ($k in $required) {
                  $val = [Environment]::GetEnvironmentVariable($k)
                  if ([string]::IsNullOrWhiteSpace($val)) { $missing += $k }
                }
                if ($missing.Count -gt 0) {
                  Write-Error "Missing required pipeline variables: $($missing -join ', ')";
                  Write-Host "Hint: link Variable Group 'EasyWay-Secrets' or define these variables at pipeline level.";
                  exit 1
                } else {
                  Write-Host "Required variables found: $($required -join ', ')"
                }
          - script: |
              cd infra/terraform
              terraform -version || true
              echo "Initializing..."
              terraform init -input=false
              echo "Validating..."
              terraform validate
              echo "Planning..."
              terraform plan -input=false -out=tfplan \
                -var "project_name=easyway" \
                -var "resource_group_name=$(RESOURCE_GROUP_NAME)" \
                -var "storage_account_name=$(STORAGE_ACCOUNT_NAME)" \
                -var "tenants=$(TENANTS)"
            displayName: 'Terraform init/validate/plan'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: tfplan'
            inputs:
              PathtoPublish: 'infra/terraform/tfplan'
              ArtifactName: 'tfplan'

      - job: TerraformApply
        displayName: Terraform Apply (main only)
        dependsOn: TerraformPlan
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
        steps:
          - script: |
              cd infra/terraform
              terraform init -input=false
              terraform apply -input=false -auto-approve tfplan || echo "Provide manual apply if needed"
            displayName: 'Terraform apply'

  - stage: DB
    displayName: Database (Validate/Migrate)
    dependsOn: Infra
    jobs:
      - job: FlywayValidateAny
        displayName: 'Flyway Validate (all branches)'
        condition: and(succeeded(), eq(variables['FLYWAY_ENABLED'], 'true'))
        steps:
          - script: |
              set -e
              FLYWAY_VERSION=$(flyway_version)
              curl -L -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz
              tar -xzf /tmp/flyway.tar.gz -C /tmp
              echo "##vso[task.prependpath]/tmp/flyway-${FLYWAY_VERSION}"
            displayName: 'Install Flyway CLI'
          - script: |
              cd db/flyway
              echo "Flyway URL: $(FLYWAY_URL)"
              export FLYWAY_URL="$(FLYWAY_URL)"
              export FLYWAY_USER="$(FLYWAY_USER)"
              export FLYWAY_PASSWORD="$(FLYWAY_PASSWORD)"
              flyway -configFiles=flyway.conf validate
            displayName: 'Run Flyway validate'

      - job: FlywayMigrateDevelop
        displayName: 'Flyway Migrate (develop only)'
        dependsOn: FlywayValidateAny
        condition: and(succeeded(), eq(variables['FLYWAY_ENABLED'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
        steps:
          - script: |
              set -e
              FLYWAY_VERSION=$(flyway_version)
              curl -L -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz
              tar -xzf /tmp/flyway.tar.gz -C /tmp
              echo "##vso[task.prependpath]/tmp/flyway-${FLYWAY_VERSION}"
            displayName: 'Install Flyway CLI'
          - script: |
              cd db/flyway
              echo "Flyway URL: $(FLYWAY_URL)"
              export FLYWAY_URL="$(FLYWAY_URL)"
              export FLYWAY_USER="$(FLYWAY_USER)"
              export FLYWAY_PASSWORD="$(FLYWAY_PASSWORD)"
              flyway -configFiles=flyway.conf migrate
            displayName: 'Run Flyway migrate (develop)'

  - stage: BuildAndTest
    displayName: Build, Lint, Test
    dependsOn: DB
    jobs:
      - job: GovernanceGatesEWCTL
        displayName: 'Governance Gates via ewctl (Checklist/Drift/KB)'
        condition: and(succeeded(), eq(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Run ewctl gates (PS engine) + logevent'
            inputs:
              targetType: 'inline'
              script: |
                pwsh scripts/ewctl.ps1 --engine ps --checklist --dbdrift --kbconsistency --noninteractive --logevent
      - job: Orchestrator
        displayName: 'Orchestrator (Plan)'
        condition: and(succeeded(), eq(variables['ENABLE_ORCHESTRATOR'], 'true'))
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'
          - task: PowerShell@2
            displayName: 'Generate orchestrator plan (TS engine)'
            inputs:
              targetType: 'inline'
              script: |
                pwsh scripts/ewctl.ps1 --engine ts --intent "$(ORCHESTRATOR_INTENT)" --noninteractive --logevent | Out-File -FilePath orchestrator-plan.json -Encoding utf8
                Write-Host "Plan written to orchestrator-plan.json"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: orchestrator-plan'
            inputs:
              PathtoPublish: 'orchestrator-plan.json'
              ArtifactName: 'orchestrator-plan'
      - job: VersionsReport
        displayName: 'Versions Report (Node/Flyway/Terraform)'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'
          - script: |
              set -e
              REPORT_FILE="$(Build.SourcesDirectory)/versions-report.txt"
              echo "Configured versions (from ci/versions.yml):"           | tee "$REPORT_FILE"
              echo "  node_version=$(node_version)"                        | tee -a "$REPORT_FILE"
              echo "  flyway_version=$(flyway_version)"                    | tee -a "$REPORT_FILE"
              echo "  terraform_version=$(terraform_version)"              | tee -a "$REPORT_FILE"
              echo ""                                                      | tee -a "$REPORT_FILE"
              echo "Detected Node & npm versions:"                         | tee -a "$REPORT_FILE"
              node -v                                                       | tee -a "$REPORT_FILE"
              npm -v                                                        | tee -a "$REPORT_FILE"
            displayName: 'Report Node/npm versions'
          - script: |
              set -e
              FLYWAY_VERSION=$(flyway_version)
              echo "Installing Flyway ${FLYWAY_VERSION} for version check..."
              curl -sSL -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz
              tar -xzf /tmp/flyway.tar.gz -C /tmp >/dev/null 2>&1 || true
              echo "##vso[task.prependpath]/tmp/flyway-${FLYWAY_VERSION}"
              flyway -v || true | tee -a "$(Build.SourcesDirectory)/versions-report.txt"
            displayName: 'Report Flyway version'
          - script: |
              set -e
              TF_VERSION=$(terraform_version)
              echo "Installing Terraform ${TF_VERSION} for version check..."
              curl -sSL -o /tmp/terraform.zip https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
              unzip -o /tmp/terraform.zip -d /tmp >/dev/null 2>&1 || true
              echo "##vso[task.prependpath]/tmp"
              terraform version || true | tee -a "$(Build.SourcesDirectory)/versions-report.txt"
            displayName: 'Report Terraform version'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: versions-report'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/versions-report.txt'
              ArtifactName: 'versions-report'
      - job: NodeBuild
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(node_version)'
            displayName: 'Use Node.js $(node_version)'

          - script: |
              cd $(workingDirectory)
              npm ci
              npm run build
            displayName: 'Install & Build'

          - script: |
              cd $(workingDirectory)
              npm run lint
            displayName: 'Lint'

          - script: |
              cd $(workingDirectory)
              npm test -- --ci --reporters=default
            displayName: 'Test'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: api-dist'
            inputs:
              PathtoPublish: '$(workingDirectory)/dist'
              ArtifactName: 'api-dist'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: openapi'
            inputs:
              PathtoPublish: '$(workingDirectory)/openapi'
              ArtifactName: 'openapi'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: agent-kb'
            inputs:
              PathtoPublish: 'agents/kb'
              ArtifactName: 'agent-kb'

      - job: WikiLint
        displayName: 'Wiki Normalize & Lint'
        steps:
          - task: PowerShell@2
            displayName: 'Normalize & Review Wiki (if scripts exist)'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Running Wiki normalize/lint if available..."
                $scripts = "Wiki/EasyWayData.wiki/scripts"
                if (Test-Path $scripts) {
                  if (Test-Path "$scripts/normalize-project.ps1") {
                    pwsh "$scripts/normalize-project.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                  if (Test-Path "$scripts/review-run.ps1") {
                    pwsh "$scripts/review-run.ps1" -Root "Wiki/EasyWayData.wiki"
                  }
                } else {
                  Write-Host "Wiki scripts folder not found, skipping."
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: wiki-logs'
            inputs:
              PathtoPublish: 'Wiki/EasyWayData.wiki/logs'
              ArtifactName: 'wiki-logs'
            condition: and(succeeded(), exists('Wiki/EasyWayData.wiki/logs'))

      - job: PreDeployChecklist
        displayName: 'Pre-Deploy Checklist (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_CHECKLIST'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
          - WikiLint
        steps:
          - task: PowerShell@2
            displayName: 'Run Checklist Bot'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                $env:CHECKLIST_OUTPUT = 'json'
                Write-Host "Running checklist..."
                $out = npm run -s check:predeploy
                $out | Out-File -FilePath checklist.json -Encoding utf8
                $json = Get-Content checklist.json -Raw | ConvertFrom-Json
                if (-not $json.summary.ok) {
                  Write-Host "Checklist FAILED"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "Checklist failed"
                } else {
                  Write-Host "Checklist OK"
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: checklist'
            inputs:
              PathtoPublish: '$(workingDirectory)/checklist.json'
              ArtifactName: 'checklist'

      - job: KBConsistency
        displayName: 'KB Consistency (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_KB_CONSISTENCY'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Verify KB/Wiki updated (DB/API + ADO scripts + agents docs)'
            inputs:
              targetType: 'inline'
              script: |
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                try { $base = (git rev-parse HEAD~1) } catch { Write-Host "Shallow repo; skipping KB Consistency check (first run)"; exit 0 }
                $changed = git diff --name-only $base HEAD
                $changedDbApi = $false
                $changedAdoScripts = $false
                $changedAgentsDocs = $false
                foreach ($f in $changed) {
                  if ($f -like 'db/*' -or $f -like 'EasyWay-DataPortal/easyway-portal-api/src/*') { $changedDbApi = $true }
                  if ($f -like 'scripts/ado/*') { $changedAdoScripts = $true }
                  if ($f -like 'Wiki/EasyWayData.wiki/agents-*.md') { $changedAgentsDocs = $true }
                }
                if (-not ($changedDbApi -or $changedAdoScripts -or $changedAgentsDocs)) {
                  Write-Host "No relevant changes (DB/API/ADO scripts/agents docs); KB not required"; exit 0 }
                $kbChanged = $false; $wikiChanged = $false
                foreach ($f in $changed) {
                  if ($f -eq 'agents/kb/recipes.jsonl') { $kbChanged = $true }
                  if ($f -like 'Wiki/*') { $wikiChanged = $true }
                }
                if ($changedDbApi -and (-not $kbChanged -or -not $wikiChanged)) {
                  Write-Error "KB Consistency failed: when DB/API changes, update agents/kb/recipes.jsonl and at least one Wiki page."
                  exit 1
                }
                if (($changedAdoScripts -or $changedAgentsDocs) -and (-not $kbChanged)) {
                  Write-Error "KB Consistency failed: changes in scripts/ado/** or Wiki/agents-*.md require updating agents/kb/recipes.jsonl (add/adjust a recipe)."
                  exit 1
                }
                Write-Host "KB Consistency OK"

      - job: DBDriftCheck
        displayName: 'DB Drift Check (Gate)'
        condition: and(succeeded(), eq(variables['ENABLE_DB_DRIFT'], 'true'), ne(variables['USE_EWCTL_GATES'], 'true'))
        dependsOn:
          - NodeBuild
        steps:
          - task: PowerShell@2
            displayName: 'Run DB Drift Check'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                Write-Host "Running DB drift check..."
                $out = npm run -s db:drift
                $out | Out-File -FilePath drift.json -Encoding utf8
                $json = Get-Content drift.json -Raw | ConvertFrom-Json
                if (-not $json.ok) {
                  Write-Host ($json | ConvertTo-Json -Depth 10)
                  throw "DB drift check failed (missing objects)"
                } else {
                  Write-Host "DB drift check OK"
                }
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: db-drift'
            inputs:
              PathtoPublish: '$(workingDirectory)/drift.json'
              ArtifactName: 'db-drift'

      - job: ActivityLog
        displayName: 'Activity Log (Append + Update Wiki)'
        dependsOn:
          - PreDeployChecklist
          - KBConsistency
          - DBDriftCheck
        condition: succeededOrFailed()
        steps:
          - task: PowerShell@2
            displayName: 'Append activity event'
            inputs:
              targetType: 'inline'
              script: |
                $intent = 'pipeline-run'
                $actor = 'agent_governance'
                $env = 'ci'
                $outcome = '$(Agent.JobStatus)'
                $refs = @("branch=$(Build.SourceBranch)", "commit=$(Build.SourceVersion)", "build=$(Build.BuildNumber)")
                $artifacts = @()
                if (Test-Path "$(workingDirectory)/checklist.json") { $artifacts += 'checklist.json' }
                if (Test-Path "$(workingDirectory)/drift.json") { $artifacts += 'drift.json' }
                if (Test-Path "$(Build.SourcesDirectory)/versions-report.txt") { $artifacts += 'versions-report.txt' }
                if (Test-Path "$(Build.SourcesDirectory)/orchestrator-plan.json") { $artifacts += 'orchestrator-plan.json' }
                pwsh scripts/activity-log.ps1 -Intent $intent -Actor $actor -Env $env -Outcome $outcome -Refs $refs -Artifacts $artifacts -Notes "CI run"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: activity-log'
            inputs:
              PathtoPublish: 'agents/logs'
              ArtifactName: 'activity-log'

      - job: GatesReport
        displayName: 'Gates Report (aggregate)'
        dependsOn:
          - PreDeployChecklist
          - KBConsistency
          - DBDriftCheck
        condition: succeededOrFailed()
        steps:
          - task: PowerShell@2
            displayName: 'Generate gates-report.json'
            inputs:
              targetType: 'inline'
              script: |
                git config --global --add safe.directory $(Build.SourcesDirectory)
                cd $(Build.SourcesDirectory)
                $report = [ordered]@{
                  checklistEnabled = '$(ENABLE_CHECKLIST)';
                  kbConsistencyEnabled = '$(ENABLE_KB_CONSISTENCY)';
                  dbDriftEnabled = '$(ENABLE_DB_DRIFT)';
                  checklistOk = (Test-Path "$(workingDirectory)/checklist.json");
                  dbDriftOk = (Test-Path "$(workingDirectory)/drift.json");
                }
                $json = ($report | ConvertTo-Json -Depth 4)
                $out = Join-Path '$(Build.SourcesDirectory)' 'gates-report.json'
                $json | Set-Content -Encoding UTF8 $out
                Write-Host "Wrote $out"
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact: gates-report'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/gates-report.json'
              ArtifactName: 'gates-report'

  # Future: add Deploy stage(s) with environments, approvals, and secret handling
  - stage: Deploy
    displayName: Deploy App Service
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(variables['ENABLE_DEPLOY'], 'true'))
    jobs:
      - job: DeployToDev
        displayName: 'Deploy to Azure Web App'
        steps:
          - task: DownloadBuildArtifacts@0
            displayName: 'Download artifact: api-dist'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'api-dist'
              downloadPath: '$(Pipeline.Workspace)'

          - task: ArchiveFiles@2
            displayName: 'Archive api-dist to zip'
            inputs:
              rootFolderOrFile: '$(Pipeline.Workspace)/api-dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Pipeline.Workspace)/api-dist.zip'
              replaceExistingArchive: true

          - task: AzureWebApp@1
            displayName: 'Deploy package to WebApp'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(WEBAPP_NAME)'
              package: '$(Pipeline.Workspace)/api-dist.zip'
              resourceGroupName: '$(RESOURCE_GROUP)'
              slotName: '$(WEBAPP_SLOT)'

          - task: AzureAppServiceSettings@1
            displayName: 'Configure App Settings'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(WEBAPP_NAME)'
              resourceGroupName: '$(RESOURCE_GROUP)'
              slotName: '$(WEBAPP_SLOT)'
              appSettings: |
                [
                  {"name":"AUTH_ISSUER","value":"$(AUTH_ISSUER)","slotSetting":false},
                  {"name":"AUTH_JWKS_URI","value":"$(AUTH_JWKS_URI)","slotSetting":false},
                  {"name":"AUTH_AUDIENCE","value":"$(AUTH_AUDIENCE)","slotSetting":false},
                  {"name":"AUTH_CLIENT_ID","value":"$(AUTH_CLIENT_ID)","slotSetting":false},
                  {"name":"AUTH_TENANT_ID","value":"$(AUTH_TENANT_ID)","slotSetting":false},
                  {"name":"TENANT_CLAIM","value":"$(TENANT_CLAIM)","slotSetting":false},
                  {"name":"DB_CONN_STRING","value":"$(DB_CONN_STRING)","slotSetting":false},
                  {"name":"AZURE_STORAGE_CONNECTION_STRING","value":"$(AZURE_STORAGE_CONNECTION_STRING)","slotSetting":false},
                  {"name":"AZURE_STORAGE_ACCOUNT","value":"$(AZURE_STORAGE_ACCOUNT)","slotSetting":false},
                  {"name":"BRANDING_CONTAINER","value":"$(BRANDING_CONTAINER)","slotSetting":false},
                  {"name":"BRANDING_PREFIX","value":"$(BRANDING_PREFIX)","slotSetting":false},
                  {"name":"DEFAULT_TENANT_ID","value":"$(DEFAULT_TENANT_ID)","slotSetting":false},
                  {"name":"RLS_CONTEXT_ENABLED","value":"$(RLS_CONTEXT_ENABLED)","slotSetting":false},
                  {"name":"LOG_LEVEL","value":"$(LOG_LEVEL)","slotSetting":false},
                  {"name":"LOG_DIR","value":"$(LOG_DIR)","slotSetting":false},
                  {"name":"APPLICATIONINSIGHTS_CONNECTION_STRING","value":"$(APPLICATIONINSIGHTS_CONNECTION_STRING)","slotSetting":false},
                  {"name":"OTEL_ENABLED","value":"$(OTEL_ENABLED)","slotSetting":false},
                  {"name":"OTEL_TRACES_SAMPLER","value":"$(OTEL_TRACES_SAMPLER)","slotSetting":false},
                  {"name":"OTEL_TRACES_SAMPLER_ARG","value":"$(OTEL_TRACES_SAMPLER_ARG)","slotSetting":false},
                  {"name":"PORTAL_BASE_PATH","value":"$(PORTAL_BASE_PATH)","slotSetting":false},
                  {"name":"RATE_LIMIT_WINDOW_MS","value":"$(RATE_LIMIT_WINDOW_MS)","slotSetting":false},
                  {"name":"RATE_LIMIT_MAX","value":"$(RATE_LIMIT_MAX)","slotSetting":false},
                  {"name":"BODY_LIMIT","value":"$(BODY_LIMIT)","slotSetting":false}
                ]
          - task: AzureAppServiceManage@0
            displayName: 'Swap Slots'
            condition: and(succeeded(), eq(variables['ENABLE_SWAP'], 'true'))
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              Action: 'Swap Slots'
              WebAppName: '$(WEBAPP_NAME)'
              ResourceGroupName: '$(RESOURCE_GROUP)'
              SourceSlot: '$(WEBAPP_SLOT)'

      - job: SyncAppSettingsDev
        displayName: 'Sync App Settings from .env.local (Dev Slot)'
        condition: and(
          succeeded(),
          eq(variables['ENABLE_SYNC_APPSETTINGS'], 'true'),
          or(ne(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['GOV_APPROVED'], 'true')),
          or(ne(variables['ENVIRONMENT'], 'prod'), eq(variables['GOV_APPROVED'], 'true'))
        )
        steps:
          - task: PowerShell@2
            displayName: 'Generate appsettings from .env.local'
            inputs:
              targetType: 'inline'
              script: |
                pwsh scripts/generate-appsettings.ps1 -ApiPath EasyWay-DataPortal/easyway-portal-api -OutDir ./out
                Get-Content ./out/appsettings.cli.json | Write-Host
          - task: AzureCLI@2
            displayName: 'Apply appsettings (Azure CLI)'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                if (-not (Test-Path './out/appsettings.cli.json')) { Write-Error 'Missing ./out/appsettings.cli.json'; exit 1 }
                if ([string]::IsNullOrWhiteSpace('$(WEBAPP_SLOT)')) {
                  az webapp config appsettings set -g "$(RESOURCE_GROUP)" -n "$(WEBAPP_NAME)" --settings @./out/appsettings.cli.json
                } else {
                  az webapp config appsettings set -g "$(RESOURCE_GROUP)" -n "$(WEBAPP_NAME)" --slot "$(WEBAPP_SLOT)" --settings @./out/appsettings.cli.json
                }

# Database Prod Migrate with approvals (main only)
- stage: DBProd
  displayName: Database (Prod Migrate with approvals)
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq(variables['FLYWAY_ENABLED'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['GOV_APPROVED'], 'true'))
  jobs:
    - deployment: FlywayMigrateMain
      displayName: 'Flyway Migrate (main, requires environment approval)'
      environment: 'prod'
      strategy:
        runOnce:
          deploy:
            steps:
              - script: |
                  set -e
                  FLYWAY_VERSION=$(flyway_version)
                  curl -L -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz
                  tar -xzf /tmp/flyway.tar.gz -C /tmp
                  echo "##vso[task.prependpath]/tmp/flyway-${FLYWAY_VERSION}"
                displayName: 'Install Flyway CLI'
              - script: |
                  cd db/flyway
                  echo "Flyway URL: $(FLYWAY_URL)"
                  export FLYWAY_URL="$(FLYWAY_URL)"
                  export FLYWAY_USER="$(FLYWAY_USER)"
                  export FLYWAY_PASSWORD="$(FLYWAY_PASSWORD)"
                  flyway -configFiles=flyway.conf validate
                  flyway -configFiles=flyway.conf migrate
                displayName: 'Run Flyway validate + migrate (prod)'
